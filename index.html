<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZugInfoMonitor</title>
    <style>
        body { background: midnightblue; color: white; font-family: sans-serif; }
        .section { margin-bottom: 20px; }
        .input-label { display: inline-block; width: 200px; }
        .displays { display: flex; flex-wrap: wrap; }
        .large { margin-right: 20px; }
        .small-displays { display: flex; }
        .small-display { margin-right: 20px; }
        canvas { background: midnightblue; }
        .header-line { position: relative; height: 100px; }
        .ziel-line, .via-line { height: 50px; }
        .large_icons { display: flex; flex-direction: row-reverse; align-items: flex-start; }
    </style>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>

<div class="settings">
    <div class="section">
        <h2>Wagenreihung</h2>
        <label><input type="radio" name="merkmal" value="rotierend"> Rotierend</label><br>
        <label><input type="radio" name="merkmal" value="wagennummern" checked> Wagennummern</label><br>
        <label><input type="radio" name="merkmal" value="ausstattung"> Ausstattung</label><br>
        <label><input type="radio" name="merkmal" value="klasse"> Klasse</label>
    </div>

    <div class="section">
        <h2>Bahnhof</h2>
        <div>
            <label class="input-label">Bahnsteigl√§nge</label><input type="text" id="bahnsteiglaenge" value="420">
        </div>
        <div>
            <label class="input-label">Bahnhof/Station</label><input type="text" id="stop_name" value="">
        </div>
        <div>
            <label class="input-label">Gleis</label><input type="text" id="gleis" value="">
        </div>
    </div>

    <div class="section">
        <h2>Data Load</h2>
        <input type="file" id="load_json" accept=".json">
        <button onclick="loadJsonData()">Load All Data from JSON</button>
    </div>

    <div class="section">
        <h2>Train 1</h2>
        <div>
            <label class="input-label">Informationen</label><input type="text" data-train="1" data-field="Informationen" value="">
        </div>
        <div>
            <label class="input-label">Zugnummer</label><input type="text" data-train="1" data-field="Zugnummer" value="">
        </div>
        <div>
            <label class="input-label">Zugnummer kurz</label><input type="text" data-train="1" data-field="Zugnummer kurz" value="">
        </div>
        <div>
            <label class="input-label">Abfahrt</label><input type="text" data-train="1" data-field="Abfahrt" value="">
        </div>
        <div>
            <label class="input-label">Abweichend</label><input type="text" data-train="1" data-field="Abweichend" value="">
        </div>
        <div>
            <label class="input-label">Ziel</label><input type="text" data-train="1" data-field="Ziel" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 1</label><input type="text" data-train="1" data-field="Via-Halte 1" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 2</label><input type="text" data-train="1" data-field="Via-Halte 2" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 3</label><input type="text" data-train="1" data-field="Via-Halte 3" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 1 Small</label><input type="text" data-train="1" data-field="Via-Halte 1 Small" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 2 Small</label><input type="text" data-train="1" data-field="Via-Halte 2 Small" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 3 Small</label><input type="text" data-train="1" data-field="Via-Halte 3 Small" value="">
        </div>
        <div>
            <label class="input-label">Gleiswechsel</label><input type="text" data-train="1" data-field="Gleiswechsel" value="0">
        </div>
        <div>
            <label class="input-label">Wagenreihung (JSON array of objects)</label><textarea data-train="1" data-field="Wagenreihung">[]</textarea>
        </div>
        <div>
            <label class="input-label">PlatformLength</label><input type="text" data-train="1" data-field="PlatformLength" value="420">
        </div>
        <div>
            <label class="input-label">PlatformSections (JSON)</label><textarea data-train="1" data-field="PlatformSections">[["A", 69.7], ["B", 135.8], ["C", 208], ["D", 266], ["E", 315.65]]</textarea>
        </div>
        <div>
            <label class="input-label">TrainStart</label><input type="text" data-train="1" data-field="TrainStart" value="0">
        </div>
        <div>
            <label class="input-label">Direction</label>
            <select data-train="1" data-field="Richtung">
                <option value="0">0</option>
                <option value="1">1</option>
            </select>
        </div>
        <div>
            <label class="input-label">Skalieren</label><input type="checkbox" data-train="1" data-field="Skalieren">
        </div>
        <div>
            <input type="file" id="load_form1" accept=".json">
            <button onclick="loadFormation(1)">Load Formation Train 1</button>
        </div>
    </div>

    <div class="section">
        <h2>Train 2</h2>
        <div>
            <label class="input-label">Informationen</label><input type="text" data-train="2" data-field="Informationen" value="">
        </div>
        <div>
            <label class="input-label">Zugnummer</label><input type="text" data-train="2" data-field="Zugnummer" value="">
        </div>
        <div>
            <label class="input-label">Zugnummer kurz</label><input type="text" data-train="2" data-field="Zugnummer kurz" value="">
        </div>
        <div>
            <label class="input-label">Abfahrt</label><input type="text" data-train="2" data-field="Abfahrt" value="">
        </div>
        <div>
            <label class="input-label">Abweichend</label><input type="text" data-train="2" data-field="Abweichend" value="">
        </div>
        <div>
            <label class="input-label">Ziel</label><input type="text" data-train="2" data-field="Ziel" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 1</label><input type="text" data-train="2" data-field="Via-Halte 1" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 2</label><input type="text" data-train="2" data-field="Via-Halte 2" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 3</label><input type="text" data-train="2" data-field="Via-Halte 3" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 1 Small</label><input type="text" data-train="2" data-field="Via-Halte 1 Small" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 2 Small</label><input type="text" data-train="2" data-field="Via-Halte 2 Small" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 3 Small</label><input type="text" data-train="2" data-field="Via-Halte 3 Small" value="">
        </div>
        <div>
            <label class="input-label">Gleiswechsel</label><input type="text" data-train="2" data-field="Gleiswechsel" value="0">
        </div>
        <div>
            <label class="input-label">Wagenreihung (JSON array of objects)</label><textarea data-train="2" data-field="Wagenreihung">[]</textarea>
        </div>
        <div>
            <label class="input-label">PlatformLength</label><input type="text" data-train="2" data-field="PlatformLength" value="420">
        </div>
        <div>
            <label class="input-label">PlatformSections (JSON)</label><textarea data-train="2" data-field="PlatformSections">[["A", 69.7], ["B", 135.8], ["C", 208], ["D", 266], ["E", 315.65]]</textarea>
        </div>
        <div>
            <label class="input-label">TrainStart</label><input type="text" data-train="2" data-field="TrainStart" value="0">
        </div>
        <div>
            <label class="input-label">Direction</label>
            <select data-train="2" data-field="Richtung">
                <option value="0">0</option>
                <option value="1">1</option>
            </select>
        </div>
        <div>
            <label class="input-label">Skalieren</label><input type="checkbox" data-train="2" data-field="Skalieren">
        </div>
        <div>
            <input type="file" id="load_form2" accept=".json">
            <button onclick="loadFormation(2)">Load Formation Train 2</button>
        </div>
    </div>

    <div class="section">
        <h2>Train 3</h2>
        <div>
            <label class="input-label">Informationen</label><input type="text" data-train="3" data-field="Informationen" value="">
        </div>
        <div>
            <label class="input-label">Zugnummer</label><input type="text" data-train="3" data-field="Zugnummer" value="">
        </div>
        <div>
            <label class="input-label">Zugnummer kurz</label><input type="text" data-train="3" data-field="Zugnummer kurz" value="">
        </div>
        <div>
            <label class="input-label">Abfahrt</label><input type="text" data-train="3" data-field="Abfahrt" value="">
        </div>
        <div>
            <label class="input-label">Abweichend</label><input type="text" data-train="3" data-field="Abweichend" value="">
        </div>
        <div>
            <label class="input-label">Ziel</label><input type="text" data-train="3" data-field="Ziel" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 1</label><input type="text" data-train="3" data-field="Via-Halte 1" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 2</label><input type="text" data-train="3" data-field="Via-Halte 2" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 3</label><input type="text" data-train="3" data-field="Via-Halte 3" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 1 Small</label><input type="text" data-train="3" data-field="Via-Halte 1 Small" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 2 Small</label><input type="text" data-train="3" data-field="Via-Halte 2 Small" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 3 Small</label><input type="text" data-train="3" data-field="Via-Halte 3 Small" value="">
        </div>
        <div>
            <label class="input-label">Gleiswechsel</label><input type="text" data-train="3" data-field="Gleiswechsel" value="0">
        </div>
        <div>
            <label class="input-label">Wagenreihung (JSON array of objects)</label><textarea data-train="3" data-field="Wagenreihung">[]</textarea>
        </div>
        <div>
            <label class="input-label">PlatformLength</label><input type="text" data-train="3" data-field="PlatformLength" value="420">
        </div>
        <div>
            <label class="input-label">PlatformSections (JSON)</label><textarea data-train="3" data-field="PlatformSections">[["A", 69.7], ["B", 135.8], ["C", 208], ["D", 266], ["E", 315.65]]</textarea>
        </div>
        <div>
            <label class="input-label">TrainStart</label><input type="text" data-train="3" data-field="TrainStart" value="0">
        </div>
        <div>
            <label class="input-label">Direction</label>
            <select data-train="3" data-field="Richtung">
                <option value="0">0</option>
                <option value="1">1</option>
            </select>
        </div>
        <div>
            <label class="input-label">Skalieren</label><input type="checkbox" data-train="3" data-field="Skalieren">
        </div>
        <div>
            <input type="file" id="load_form3" accept=".json">
            <button onclick="loadFormation(3)">Load Formation Train 3</button>
        </div>
    </div>
</div>

<button onclick="downloadScreenshot()">Download Screenshot</button>

<div class="displays">
    <div class="large">
        <h3>Large Display (Train 1 Full Screen)</h3>
        <div class="header-line">
            <canvas id="large_header" width="1880" height="200" style="width:940px; height:100px; position: absolute; left:0;"></canvas>
            <div class="large_icons" style="position: absolute; right: 0; top: 0; height:100px; display: flex; flex-direction: row-reverse; align-items: flex-start;"></div>
        </div>
        <div class="ziel-line">
            <canvas id="large_ziel" width="1880" height="100" style="width:940px; height:50px;"></canvas>
        </div>
        <div class="via-line">
            <canvas id="large_via1" width="1880" height="100" style="width:940px; height:50px;"></canvas>
        </div>
        <div class="via-line">
            <canvas id="large_via2" width="1880" height="100" style="width:940px; height:50px;"></canvas>
        </div>
        <div class="via-line">
            <canvas id="large_via3" width="1880" height="100" style="width:940px; height:50px;"></canvas>
        </div>
        <canvas id="large_formation" width="1880" height="258" style="width:940px; height:129px;"></canvas>
    </div>
    <div class="small-displays">
        <div class="small-display">
            <h3>Small Display (Train 2)</h3>
            <canvas id="small2_header" width="940" height="120" style="width:470px; height:60px;"></canvas>
            <canvas id="small2_info" width="940" height="60" style="width:470px; height:30px;"></canvas>
            <canvas id="small2_ziel" width="940" height="60" style="width:470px; height:30px;"></canvas>
            <canvas id="small2_via1" width="940" height="60" style="width:470px; height:30px;"></canvas>
            <canvas id="small2_via2" width="940" height="60" style="width:470px; height:30px;"></canvas>
            <canvas id="small2_via3" width="940" height="60" style="width:470px; height:30px;"></canvas>
            <canvas id="small2_formation" width="940" height="258" style="width:470px; height:129px;"></canvas>
        </div>
        <div class="small-display">
            <h3>Small Display (Train 3)</h3>
            <canvas id="small3_header" width="940" height="120" style="width:470px; height:60px;"></canvas>
            <canvas id="small3_info" width="940" height="60" style="width:470px; height:30px;"></canvas>
            <canvas id="small3_ziel" width="940" height="60" style="width:470px; height:30px;"></canvas>
            <canvas id="small3_via1" width="940" height="60" style="width:470px; height:30px;"></canvas>
            <canvas id="small3_via2" width="940" height="60" style="width:470px; height:30px;"></canvas>
            <canvas id="small3_via3" width="940" height="60" style="width:470px; height:30px;"></canvas>
            <canvas id="small3_formation" width="940" height="258" style="width:470px; height:129px;"></canvas>
        </div>
    </div>
</div>

<script>
const scale = 2;

class Coach {
    constructor(coach_type, double_decker, length, coach_class, coach_number, amenities, start, stop) {
        this.coach_type = coach_type;
        this.double_decker = double_decker;
        this.length = parseInt(length) || 0;
        this.coach_class = parseInt(coach_class) || null;
        this.coach_number = parseInt(coach_number) || 0;
        this.amenities = amenities || '';
        this.start = parseInt(start) || 0;
        this.stop = parseInt(stop) || 0;
    }
    has_amenity(amenity) {
        return this.amenities === amenity;
    }
    is_first_class() {
        return this.coach_class === 1;
    }
    is_locomotive() {
        return this.coach_type === 'l';
    }
}

let trainData = {
    zug_daten: {
        1: {
            "Informationen": "", "Zugnummer": "", "Zugnummer kurz": "", "Abfahrt": "", "Abweichend": "", "Ziel": "", 
            "Via-Halte 1": "", "Via-Halte 2": "", "Via-Halte 3": "", "Via-Halte 1 Small": "", "Via-Halte 2 Small": "", "Via-Halte 3 Small": "", "Gleiswechsel": "0",
            "Wagenreihung": [], "PlatformLength": 420, "PlatformSections": [["A", 69.7], ["B", 135.8], ["C", 208], ["D", 266], ["E", 315.65]], "TrainStart": 0, "Richtung": 0, "Skalieren": false
        },
        2: {
            "Informationen": "", "Zugnummer": "", "Zugnummer kurz": "", "Abfahrt": "", "Abweichend": "", "Ziel": "", 
            "Via-Halte 1": "", "Via-Halte 2": "", "Via-Halte 3": "", "Via-Halte 1 Small": "", "Via-Halte 2 Small": "", "Via-Halte 3 Small": "", "Gleiswechsel": "0",
            "Wagenreihung": [], "PlatformLength": 420, "PlatformSections": [["A", 69.7], ["B", 135.8], ["C", 208], ["D", 266], ["E", 315.65]], "TrainStart": 0, "Richtung": 0, "Skalieren": false
        },
        3: {
            "Informationen": "", "Zugnummer": "", "Zugnummer kurz": "", "Abfahrt": "", "Abweichend": "", "Ziel": "", 
            "Via-Halte 1": "", "Via-Halte 2": "", "Via-Halte 3": "", "Via-Halte 1 Small": "", "Via-Halte 2 Small": "", "Via-Halte 3 Small": "", "Gleiswechsel": "0",
            "Wagenreihung": [], "PlatformLength": 420, "PlatformSections": [["A", 69.7], ["B", 135.8], ["C", 208], ["D", 266], ["E", 315.65]], "TrainStart": 0, "Richtung": 0, "Skalieren": false
        }
    },
    current_stop: "",
    current_platform: ""
};

const inputs = document.querySelectorAll('input[data-train], textarea[data-train], select[data-train]');
inputs.forEach(input => {
    input.addEventListener('input', () => {
        const train = input.dataset.train;
        const field = input.dataset.field;
        let val;
        if (input.type === 'checkbox') {
            val = input.checked;
        } else if (input.tagName === 'SELECT') {
            val = parseInt(input.value);
        } else {
            val = input.value;
        }
        if (field === 'Wagenreihung') {
            try {
                val = JSON.parse(val);
                trainData.zug_daten[train][field] = val.map(obj => new Coach(obj.coach_type, obj.double_decker, obj.length, obj.coach_class, obj.coach_number, obj.amenities, obj.start, obj.stop));
            } catch (e) {
                console.error('Invalid Wagenreihung JSON');
            }
        } else if (field === 'PlatformSections') {
            try {
                trainData.zug_daten[train][field] = JSON.parse(val);
            } catch (e) {
                console.error('Invalid PlatformSections JSON');
            }
        } else if (['PlatformLength', 'TrainStart', 'Richtung', 'Gleiswechsel'].includes(field)) {
            trainData.zug_daten[train][field] = parseFloat(val) || 0;
        } else if (field === 'Skalieren') {
            trainData.zug_daten[train][field] = val;
        } else {
            trainData.zug_daten[train][field] = val;
        }
        updateAllDisplays();
    });
});

document.getElementById('bahnsteiglaenge').addEventListener('input', () => {
    const value = parseFloat(document.getElementById('bahnsteiglaenge').value) || 420;
    for (let i = 1; i <= 3; i++) {
        trainData.zug_daten[i]['PlatformLength'] = value;
    }
    updateAllDisplays();
});

document.getElementById('stop_name').addEventListener('input', () => {
    trainData.current_stop = document.getElementById('stop_name').value;
});

document.getElementById('gleis').addEventListener('input', () => {
    trainData.current_platform = document.getElementById('gleis').value;
});

let aktuelles_merkmal = 'wagennummern';
let rotating = false;
let rotationsIndex = 0;
let merkmale = ['wagennummern', 'ausstattung', 'klasse'];
let rotationTimer = null;

const merkmalRadios = document.querySelectorAll('input[name="merkmal"]');
merkmalRadios.forEach(radio => {
    radio.addEventListener('change', () => {
        if (radio.value === 'rotierend') {
            rotating = true;
            rotateFeature();
        } else {
            rotating = false;
            if (rotationTimer) clearTimeout(rotationTimer);
            aktuelles_merkmal = radio.value;
            updateAllFormations();
        }
    });
});

function rotateFeature() {
    if (!rotating) return;
    aktuelles_merkmal = merkmale[rotationsIndex];
    rotationsIndex = (rotationsIndex + 1) % merkmale.length;
    updateAllFormations();
    rotationTimer = setTimeout(rotateFeature, 3000);
}

let scrollIntervals = {};

function startScroll(canvasId, text, font, color, startX, y, speed = 2, bg = null) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    ctx.font = font;
    const textWidth = ctx.measureText(text).width;
    const canvasWidth = canvas.width / scale;
    if (textWidth <= canvasWidth - startX) {
        ctx.clearRect(0, 0, canvasWidth, canvas.height / scale);
        if (bg) {
            ctx.fillStyle = bg;
            ctx.fillRect(0, 0, canvasWidth, canvas.height / scale);
        }
        ctx.fillStyle = color;
        ctx.fillText(text, startX, y);
        return;
    }
    let x = startX;
    if (scrollIntervals[canvasId]) clearInterval(scrollIntervals[canvasId]);
    scrollIntervals[canvasId] = setInterval(() => {
        ctx.clearRect(0, 0, canvasWidth, canvas.height / scale);
        if (bg) {
            ctx.fillStyle = bg;
            ctx.fillRect(0, 0, canvasWidth, canvas.height / scale);
        }
        ctx.fillStyle = color;
        ctx.fillText(text, x, y);
        x -= speed;
        if (x < -textWidth) x = canvasWidth;
    }, 30);
}

function stopScroll(canvasId) {
    if (scrollIntervals[canvasId]) clearInterval(scrollIntervals[canvasId]);
    delete scrollIntervals[canvasId];
}

function updateAllDisplays() {
    updateTrainDisplay(1, 'large', true);
    updateTrainDisplay(2, 'small2', false);
    updateTrainDisplay(3, 'small3', false);
}

function updateAllFormations() {
    updateCoachSequence(1, 'large_formation', true);
    updateCoachSequence(2, 'small2_formation', false);
    updateCoachSequence(3, 'small3_formation', false);
}

function updateCoachSequence(zug_nr, canvasId, fullScreen) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    ctx.scale(scale, scale);
    const draw_width = fullScreen ? 940 : 470;
    const draw_height = 129;
    ctx.clearRect(0, 0, draw_width, draw_height);
    let coaches = trainData.zug_daten[zug_nr].Wagenreihung.slice() || [];
    let platform_length = trainData.zug_daten[zug_nr].PlatformLength || 420;
    let platform_sections = trainData.zug_daten[zug_nr].PlatformSections.slice() || [];
    const train_start = trainData.zug_daten[zug_nr].TrainStart || 0;
    const richtung = trainData.zug_daten[zug_nr].Richtung || 0;
    const skalieren = trainData.zug_daten[zug_nr].Skalieren || false;
    const gleiswechsel = trainData.zug_daten[zug_nr].Gleiswechsel || "0";
    const nr = trainData.zug_daten[zug_nr]["Zugnummer"] || "";
    if (gleiswechsel !== "0" && canvasId === 'small3_formation') {
        ctx.fillStyle = 'orange';
        ctx.fillRect(0, 0, draw_width, draw_height);
        ctx.fillStyle = 'white';
        ctx.font = '20px sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText('Neues Gleis', 25, 25);
        ctx.font = 'italic 20px sans-serif';
        ctx.fillText('New Track', 25, 55);
        ctx.font = '42px sans-serif';
        ctx.textAlign = 'right';
        ctx.fillText(gleiswechsel, 445, 40);
        return;
    }
    if (coaches.length === 0 && nr && !fullScreen) {
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(0, 129);
        ctx.moveTo(draw_width, 0);
        ctx.lineTo(draw_width, 129);
        ctx.stroke();
        return;
    }
    if (coaches.length > 0) {
        if (richtung === 1) {
            coaches.forEach(coach => {
                if (coach.coach_type === 'a') coach.coach_type = 'e';
                else if (coach.coach_type === 'e') coach.coach_type = 'a';
                if (coach.coach_type === 'ma') coach.coach_type = 'me';
                else if (coach.coach_type === 'me') coach.coach_type = 'ma';
                const old_start = coach.start;
                coach.start = platform_length - coach.stop;
                coach.stop = coach.start + coach.length;
            });
            coaches.reverse();
            platform_sections.reverse();
            platform_sections.forEach(s => s[1] = platform_length - s[1]);
        }
        let min_start = Math.min(...coaches.map(c => c.start));
        let max_stop = Math.max(...coaches.map(c => c.stop));
        let train_length = max_stop - min_start;
        let factor = skalieren ? draw_width / train_length : draw_width / platform_length;
        coaches.forEach(coach => {
            coach.start = (coach.start - min_start - train_start) * factor;
            coach.stop = coach.start + (coach.stop - coach.start) * factor;
            coach.length = coach.stop - coach.start;
        });
        printDirection(richtung, 0, ctx);
        coaches.forEach(coach => {
            let x = coach.start;
            if (coach.is_locomotive()) {
                printLocomotive(coach, x, ctx);
            } else if (['a', 'ma'].includes(coach.coach_type)) {
                printStartWagon(coach, x, ctx);
            } else if (coach.coach_type === 'm') {
                printMiddleWagon(coach, x, ctx);
            } else if (['e', 'me'].includes(coach.coach_type)) {
                printEndWagon(coach, x, ctx);
            }
            printFirstClass(coach, x, ctx, fullScreen);
        });
        if (aktuelles_merkmal === 'klasse') {
            if (fullScreen) {
                printClassCompact(coaches, ctx);
            } else {
                coaches.forEach(coach => printClass(coach, coach.start, ctx));
            }
        } else if (aktuelles_merkmal === 'ausstattung') {
            if (fullScreen) {
                printAmenitiesCompact(coaches, ctx);
            } else {
                coaches.forEach(coach => printAmenities(coach, coach.start, ctx));
            }
        } else if (aktuelles_merkmal === 'wagennummern') {
            if (fullScreen) {
                printWagonNumbersCompact(coaches, ctx);
            } else {
                coaches.forEach(coach => printWagonNumbers(coach, coach.start, ctx));
            }
        }
        if (!skalieren && platform_sections.length > 0) {
            printSectors(platform_sections, ctx, fullScreen, factor, platform_length);
        }
    }
}

function printDirection(richtung, x, ctx) {
    const y = 35;
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 2;
    ctx.beginPath();
    if (richtung === 0) {
        ctx.moveTo(x, y + 20);
        ctx.lineTo(x + 10, y + 10);
        ctx.moveTo(x, y + 20);
        ctx.lineTo(x + 15, y + 20);
        ctx.moveTo(x, y + 20);
        ctx.lineTo(x + 10, y + 30);
    } else {
        ctx.moveTo(x + 15, y + 20);
        ctx.lineTo(x + 5, y + 10);
        ctx.moveTo(x + 15, y + 20);
        ctx.lineTo(x, y + 20);
        ctx.moveTo(x + 15, y + 20);
        ctx.lineTo(x + 5, y + 30);
    }
    ctx.stroke();
}

function printStartWagon(coach, x, ctx) {
    const y = 35;
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(x, y + 40 + 2);
    ctx.lineTo(x, y + 10);
    ctx.lineTo(x + 6, y);
    ctx.lineTo(x + coach.length, y);
    ctx.moveTo(x, y + 40);
    ctx.lineTo(x + coach.length, y + 40);
    ctx.stroke();
}

function printMiddleWagon(coach, x, ctx) {
    const y = 35;
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x + coach.length, y);
    ctx.moveTo(x, y + 40);
    ctx.lineTo(x + coach.length, y + 40);
    if (coach.coach_type === 'ma') {
        ctx.moveTo(x, y);
        ctx.lineTo(x, y + 40 + 2);
    } else if (coach.coach_type === 'me') {
        ctx.moveTo(x + coach.length, y);
        ctx.lineTo(x + coach.length, y + 40 + 2);
    }
    ctx.stroke();
}

function printEndWagon(coach, x, ctx) {
    const y = 35;
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x + coach.length - 6, y);
    ctx.lineTo(x + coach.length, y + 10);
    ctx.lineTo(x + coach.length, y + 40 + 2);
    ctx.moveTo(x, y + 40);
    ctx.lineTo(x + coach.length, y + 40);
    ctx.stroke();
}

function printLocomotive(coach, x, ctx) {
    const y = 35;
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(x, y + 40 + 2);
    ctx.lineTo(x, y + 16);
    ctx.lineTo(x + 4, y + 8);
    ctx.lineTo(x + coach.length - 4, y + 8);
    ctx.lineTo(x + coach.length, y + 16);
    ctx.lineTo(x + coach.length, y + 40 + 2);
    ctx.moveTo(x, y + 40);
    ctx.lineTo(x + coach.length, y + 40);
    ctx.stroke();
}

function printFirstClass(coach, x, ctx, fullScreen) {
    const y = 35;
    if (coach.is_first_class()) {
        ctx.fillStyle = 'orange';
        let end = x + coach.length;
        if (!fullScreen) {
            if (coach.coach_type === 'e') end += 2;
            else if (coach.coach_type === 'a') end -= 2;
        }
        ctx.fillRect(x, y + 46, end - x, 10);
    }
}

function printClass(coach, x, ctx) {
    const y = 35;
    ctx.textAlign = 'center';
    if (coach.is_first_class()) {
        ctx.fillStyle = 'orange';
        ctx.font = 'bold 16px sans-serif';
        ctx.fillText("1.", x + (coach.length / 2), y + 20);
    } else if (coach.coach_class === 2 && !coach.is_locomotive()) {
        ctx.fillStyle = 'white';
        ctx.font = '16px sans-serif';
        ctx.fillText("2.", x + (coach.length / 2), y + 20);
    }
}

function printClassCompact(coaches, ctx) {
    let group = [];  
    function processGroup(group) {
        if (!group.length) return;
        const first = group[0];
        const last = group[group.length - 1];
        const start_pos = first.start;
        const end_pos = last.start + last.length;
        const center = (start_pos + end_pos) / 2;
        const current_class = first.coach_class;
        ctx.textAlign = 'center';
        if (current_class === 1) {
            ctx.fillStyle = 'orange';
            ctx.font = 'bold 16px sans-serif';
            ctx.fillText("1.", center, 35 + 20);
        } else if (current_class === 2) {
            
        }
    }
    coaches.forEach(coach => {
        if (['a', 'ma', 'm'].includes(coach.coach_type)) {
            if (!group.length || coach.coach_class === group[0].coach_class) {
                group.push(coach);
            } else {
                processGroup(group);
                group = [coach];
            }
        } else if (['e', 'me'].includes(coach.coach_type)) {
            if (group.length && coach.coach_class === group[0].coach_class) {
                group.push(coach);
            } else if (group.length) {
                processGroup(group);
                group = [coach];
            } else {
                group = [coach];
            }
            processGroup(group);
            group = [];
        } else {  
            processGroup(group);
            group = [];
        }
    });
    processGroup(group);
}

function printAmenities(coach, x, ctx) {
    const y = 35;
    ctx.fillStyle = 'white';
    ctx.font = '16px sans-serif';
    ctx.textAlign = 'center';
    if (coach.has_amenity('f')) {
        ctx.fillText('f', x + (coach.length / 2), y + 20);
    } else if (coach.has_amenity('r')) {
        ctx.fillText('r', x + (coach.length / 2), y + 20);
    } else if (coach.has_amenity('m')) {
        ctx.fillText('m', x + (coach.length / 2), y + 20);
    } else if (coach.has_amenity('g')) {
        ctx.fillText('g', x + (coach.length / 2), y + 20);
    }
}

function printAmenitiesCompact(coaches, ctx) {
    let group = [];
    function processGroup(group) {
        if (!group.length) return;
        const first = group[0];
        const last = group[group.length - 1];
        const center = (first.start + last.stop) / 2;
        const amenity = first.amenities;
        if (amenity) {
            ctx.fillStyle = 'white';
            ctx.font = '16px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(amenity, center, 35 + 20);
        }
    }
    coaches.forEach(coach => {
        if (!group.length || coach.amenities === group[0].amenities) {
            group.push(coach);
        } else {
            processGroup(group);
            group = [coach];
        }
    });
    processGroup(group);
}

function printWagonNumbers(coach, x, ctx) {
    const y = 35;
    if (coach.coach_number) {
        ctx.fillStyle = 'white';
        ctx.font = '16px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(coach.coach_number, x + (coach.length / 2), y - 10);
    }
}

function printWagonNumbersCompact(coaches, ctx) {
    let group = [];
    function processGroup(group) {
        if (!group.length) return;
        const first = group[0];
        const last = group[group.length - 1];
        const center = (first.start + last.stop) / 2;
        if (first.coach_number && last.coach_number) {
            let text = first.coach_number === last.coach_number ? first.coach_number.toString() : first.coach_number + '-' + last.coach_number;
            ctx.fillStyle = 'white';
            ctx.font = '16px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(text, center, 35 - 10);
        }
    }
    coaches.forEach(coach => {
        if (!group.length || (coach.coach_number === group[group.length - 1].coach_number + 1)) {
            group.push(coach);
        } else {
            processGroup(group);
            group = [coach];
        }
    });
    processGroup(group);
}

function printSectors(platform_sections, ctx, fullScreen, factor, platform_length) {
    platform_sections.forEach(section => {
        const pos = section[1] * factor;
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(pos, 0);
        ctx.lineTo(pos, 80);
        ctx.stroke();
        ctx.fillStyle = 'white';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(section[0], pos, 90);
    });
}

function printCoachSequence(coaches, richtung, platform_length, start_meter, factor, ctx, fullScreen, min_start, skalieren) {
    printDirection(richtung, 0, ctx);
    coaches.forEach(coach => {
        let x = coach.start;
        if (coach.is_locomotive()) {
            printLocomotive(coach, x, ctx);
        } else if (['a', 'ma'].includes(coach.coach_type)) {
            printStartWagon(coach, x, ctx);
        } else if (coach.coach_type === 'm') {
            printMiddleWagon(coach, x, ctx);
        } else if (['e', 'me'].includes(coach.coach_type)) {
            printEndWagon(coach, x, ctx);
        }
        printFirstClass(coach, x, ctx, fullScreen);
    });
}

function updateTrainDisplay(zug_nr, prefix, fullScreen) {
    const nr = trainData.zug_daten[zug_nr]["Zugnummer"] || "";
    const nr_kurz = trainData.zug_daten[zug_nr]["Zugnummer kurz"] || "";
    const abfahrt = trainData.zug_daten[zug_nr]["Abfahrt"] || "";
    const abfahrt_a = trainData.zug_daten[zug_nr]["Abweichend"] || "";
    const ziel = trainData.zug_daten[zug_nr]["Ziel"] || "";
    const info = trainData.zug_daten[zug_nr]["Informationen"] || "";
    const via = fullScreen ? trainData.zug_daten[zug_nr]["Via-Halte 1"] || "" : trainData.zug_daten[zug_nr]["Via-Halte 1 Small"] || "";
    const via2 = fullScreen ? trainData.zug_daten[zug_nr]["Via-Halte 2"] || "" : trainData.zug_daten[zug_nr]["Via-Halte 2 Small"] || "";
    const via3 = fullScreen ? trainData.zug_daten[zug_nr]["Via-Halte 3"] || "" : trainData.zug_daten[zug_nr]["Via-Halte 3 Small"] || "";
    const gleiswechsel = trainData.zug_daten[zug_nr]["Gleiswechsel"] || "0";

    // Header
    let headerCanvas = document.getElementById(prefix + '_header');
    let ctxHeader = headerCanvas.getContext('2d');
    ctxHeader.scale(scale, scale);
    ctxHeader.clearRect(0, 0, headerCanvas.width / scale, headerCanvas.height / scale);
    if (fullScreen) {
        ctxHeader.fillStyle = 'white';
        ctxHeader.font = 'bold 42px sans-serif';
        ctxHeader.textAlign = 'left';
        ctxHeader.fillText(nr_kurz, 25, 25);
        ctxHeader.font = 'bold 60px sans-serif';
        ctxHeader.fillText(abfahrt, 25, 60);
        if (abfahrt_a) {
            ctxHeader.font = '42px sans-serif';
            ctxHeader.fillText('+', 125, 60);
            ctxHeader.fillStyle = 'red';
            ctxHeader.fillText(abfahrt_a, 145, 60);
        }
    } else {
        ctxHeader.fillStyle = 'white';
        ctxHeader.font = 'bold 23px sans-serif';
        ctxHeader.textAlign = 'left';
        ctxHeader.fillText(nr, 5, 25);
        ctxHeader.font = 'bold 25px sans-serif';
        ctxHeader.fillText(abfahrt, 5, 55);
        if (abfahrt_a) {
            ctxHeader.font = '25px sans-serif';
            ctxHeader.fillText('+', 55, 55);
            ctxHeader.fillStyle = 'red';
            ctxHeader.fillText(abfahrt_a, 75, 55);
        }
    }

    // Info
    if (fullScreen) {
        const iconsDiv = document.querySelector('.large_icons');
        iconsDiv.innerHTML = '';
        const messages = info.split(' +++ ');
        const iconMap = {
            'Zug f√§llt heute aus': 'icons/ausfall.png',
            'Keine Weiterfahrt bis': 'icons/keine_weiterfahrt.png',
            'Halt entf√§llt in': 'icons/haltentfall.png',
            'Zus√§tzlicher Halt in': 'icons/zusatzhalt.png',
            'Wagen fehlen': 'icons/wagen_fehlen.png',
            'Reservierungspflichtig': 'icons/reservierungspflichtig.png',
            'Fahrradmitnahme reservierungspflichtig': 'icons/fahrradmitnahme_reservierungspflichtig.png',
            'Kein gastronomisches Angebot': 'icons/kein_gastronmisches_angebot.png'
        };
        let x = 0; // Since flex reverse, add from left, but reverse will right align
        messages.forEach(msg => {
            for (let key in iconMap) {
                if (msg.includes(key)) {
                    const img = document.createElement('img');
                    img.src = iconMap[key];
                    img.style.width = '50px';
                    img.style.marginLeft = '10px';
                    iconsDiv.appendChild(img);
                    break;
                }
            }
        });
    } else {
        let infoCanvas = document.getElementById(prefix + '_info');
        let ctxInfo = infoCanvas.getContext('2d');
        ctxInfo.scale(scale, scale);
        ctxInfo.clearRect(0, 0, infoCanvas.width / scale, infoCanvas.height / scale);
        stopScroll(prefix + '_info');
        const font = '20px sans-serif';
        const startX = 5;
        const y = 15;
        if (info.length > 40) {
            startScroll(prefix + '_info', info, font, 'white', startX, y, 2);
        } else {
            ctxInfo.fillStyle = 'white';
            ctxInfo.font = font;
            ctxInfo.textAlign = 'left';
            ctxInfo.fillText(info, startX, y);
        }
    }

    // Ziel
    let zielCanvas = document.getElementById(prefix + '_ziel');
    let ctxZiel = zielCanvas.getContext('2d');
    ctxZiel.scale(scale, scale);
    ctxZiel.clearRect(0, 0, zielCanvas.width / scale, zielCanvas.height / scale);
    stopScroll(prefix + '_ziel');
    let zielText = fullScreen ? "Ziel: " + ziel : ziel;
    const zielFont = fullScreen ? 'bold 25px sans-serif' : '20px sans-serif';
    const zielX = fullScreen ? 25 : 5;
    const zielY = fullScreen ? 25 : 15;
    const maxLen = fullScreen ? 60 : 40;
    if (zielText.length > maxLen) {
        startScroll(prefix + '_ziel', zielText, zielFont, 'white', zielX, zielY, 2);
    } else {
        ctxZiel.fillStyle = 'white';
        ctxZiel.font = zielFont;
        ctxZiel.textAlign = 'left';
        ctxZiel.fillText(zielText, zielX, zielY);
    }

    // Via1
    let via1Canvas = document.getElementById(prefix + '_via1');
    let ctxVia1 = via1Canvas.getContext('2d');
    ctxVia1.scale(scale, scale);
    ctxVia1.clearRect(0, 0, via1Canvas.width / scale, via1Canvas.height / scale);
    stopScroll(prefix + '_via1');
    let via1Text = fullScreen ? "√ºber " + via : via;
    const via1Font = fullScreen ? 'bold 25px sans-serif' : '20px sans-serif';
    const viaX = fullScreen ? 25 : 5;
    const viaY = fullScreen ? 25 : 15;
    if (via1Text.length > maxLen) {
        startScroll(prefix + '_via1', via1Text, via1Font, 'white', viaX, viaY, 2);
    } else {
        ctxVia1.fillStyle = 'white';
        ctxVia1.font = via1Font;
        ctxVia1.textAlign = 'left';
        ctxVia1.fillText(via1Text, viaX, viaY);
    }

    // Via2
    let via2Canvas = document.getElementById(prefix + '_via2');
    let ctxVia2 = via2Canvas.getContext('2d');
    ctxVia2.scale(scale, scale);
    ctxVia2.clearRect(0, 0, via2Canvas.width / scale, via2Canvas.height / scale);
    stopScroll(prefix + '_via2');
    const via2Font = fullScreen ? '25px sans-serif' : 'italic 20px sans-serif';
    if (via2.length > maxLen) {
        startScroll(prefix + '_via2', via2, via2Font, 'white', viaX, viaY, 2);
    } else {
        ctxVia2.fillStyle = 'white';
        ctxVia2.font = via2Font;
        ctxVia2.textAlign = 'left';
        ctxVia2.fillText(via2, viaX, viaY);
    }

    // Via3
    let via3Canvas = document.getElementById(prefix + '_via3');
    let ctxVia3 = via3Canvas.getContext('2d');
    ctxVia3.scale(scale, scale);
    ctxVia3.clearRect(0, 0, via3Canvas.width / scale, via3Canvas.height / scale);
    stopScroll(prefix + '_via3');
    const via3Font = fullScreen ? '25px sans-serif' : 'italic 20px sans-serif';
    if (via3.length > maxLen) {
        startScroll(prefix + '_via3', via3, via3Font, 'white', viaX, viaY, 2);
    } else {
        ctxVia3.fillStyle = 'white';
        ctxVia3.font = via3Font;
        ctxVia3.textAlign = 'left';
        ctxVia3.fillText(via3, viaX, viaY);
    }

    updateCoachSequence(zug_nr, prefix + '_formation', fullScreen);
}

function loadJsonData() {
    const file = document.getElementById('load_json').files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        const data = JSON.parse(e.target.result);
        for (let i = 1; i <= 3; i++) {
            const zug = data[`zug_${i}`];
            if (zug) {
                Object.keys(zug).forEach(key => {
                    if (key === 'Wagenreihung') {
                        trainData.zug_daten[i][key] = zug[key].map(c => new Coach(c.coach_type, c.double_decker, c.length, c.coach_class, c.coach_number, c.amenities, c.start, c.stop));
                    } else if (key === 'PlatformSections') {
                        trainData.zug_daten[i][key] = zug[key];
                    } else if (['PlatformLength', 'TrainStart', 'Richtung', 'Gleiswechsel'].includes(key)) {
                        trainData.zug_daten[i][key] = Number(zug[key]);
                    } else if (key === 'Skalieren') {
                        trainData.zug_daten[i][key] = zug[key];
                    } else {
                        trainData.zug_daten[i][key] = zug[key];
                    }
                });
                // Update inputs
                document.querySelectorAll(`[data-train="${i}"]`).forEach(inp => {
                    const field = inp.dataset.field;
                    const val = trainData.zug_daten[i][field];
                    if (inp.type === 'checkbox') {
                        inp.checked = val;
                    } else if (inp.tagName === 'TEXTAREA') {
                        inp.value = JSON.stringify(val);
                    } else if (inp.tagName === 'SELECT') {
                        inp.value = val;
                    } else {
                        inp.value = val;
                    }
                });
            }
        }
        updateAllDisplays();
    };
    reader.readAsText(file);
}

function loadFormation(train) {
    const file = document.getElementById(`load_form${train}`).files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        const arr = JSON.parse(e.target.result);
        trainData.zug_daten[train].Wagenreihung = arr.map(c => new Coach(c.coach_type, c.double_decker, c.length, c.coach_class, c.coach_number, c.amenities, c.start, c.stop));
        document.querySelector(`[data-train="${train}"][data-field="Wagenreihung"]`).value = JSON.stringify(arr);
        updateAllDisplays();
    };
    reader.readAsText(file);
}

function downloadScreenshot() {
    html2canvas(document.querySelector('.displays'), {scale: 2}).then(canvas => {
        let link = document.createElement('a');
        link.download = 'zuginfo.png';
        link.href = canvas.toDataURL();
        link.click();
    });
}

updateAllDisplays();
</script>
</body>
</html>
