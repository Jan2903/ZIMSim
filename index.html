<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Train Display</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans+Condensed:wght@600&display=swap" rel="stylesheet">
    <style>
        body { background: black; color: white; font-family: sans-serif; }
        canvas { border: 1px solid white; max-width: 100%; height: auto; }
        .preview-container { position: relative; margin-bottom: 20px; }
        .small-previews { display: flex; gap: 20px; }
    </style>
</head>
<body>
    <h1>Train Display Editor</h1>

    <!-- Shared Settings -->
    <section>
        <h2>Shared Settings</h2>
        <label>Bahnsteiglänge: <input id="bahnsteiglaenge" type="number" value="420"></label>
        <label>Bahnhof/Station: <input id="bahnhof" type="text" value="Example Station"></label>
        <label>Gleis: <input id="gleis" type="text" value="1"></label>
    </section>

    <!-- Merkmal Selection -->
    <section>
        <h2>Wagenreihung View</h2>
        <label><input type="radio" name="merkmal" value="wagennummern" checked> Wagennummern</label>
        <label><input type="radio" name="merkmal" value="ausstattung"> Ausstattung</label>
        <label><input type="radio" name="merkmal" value="klasse"> Klasse</label>
        <label><input type="radio" name="merkmal" value="rotierend"> Rotierend</label>
    </section>

    <!-- Zug 1 -->
    <section>
        <h2>Daten Zug 1 (Full Screen)</h2>
        <label>Zuglinie/Zugnummer: <input id="zug1-zugnummer" type="text" value="IC 123"></label>
        <label>Abfahrt: <input id="zug1-abfahrt" type="text" value="12:34"></label>
        <label>Abweichend: <input id="zug1-abweichend" type="text" value=""></label>
        <label>Ziel: <input id="zug1-ziel" type="text" value="Berlin Hbf"></label>
        <label>Via-Halte 1: <input id="zug1-via1" type="text" value="Hamburg"></label>
        <label>Via-Halte 2: <input id="zug1-via2" type="text" value="Bremen"></label>
        <label>Via-Halte 3: <input id="zug1-via3" type="text" value=""></label>
        <label>Via-Halte 1 Small: <input id="zug1-via1-small" type="text" value="Hmb"></label>
        <label>Via-Halte 2 Small: <input id="zug1-via2-small" type="text" value="Brm"></label>
        <label>Via-Halte 3 Small: <input id="zug1-via3-small" type="text" value=""></label>
        <label>Informationen: <input id="zug1-informationen" type="text" value="This is a long scrolling information text that needs to scroll because it's too long for the display area. Repeat for testing."></label>
        <label>Richtung: <input type="radio" name="zug1-richtung" value="0"> Links <input type="radio" name="zug1-richtung" value="1" checked> Rechts</label>
        <label>Startmeter: <input id="zug1-startmeter" type="number" value="0"></label>
        <label>Skalieren: <input id="zug1-skalieren" type="checkbox"></label>
        <label>Gleiswechsel: <input id="zug1-gleiswechsel" type="text" value="0"></label>
        <label>Wagenreihung (JSON): <textarea id="zug1-wagenreihung" rows="5">[{"coach_type":"l","double_decker":false,"length":20,"coach_class":0,"coach_number":0,"amenities":"","start":0,"stop":20},{"coach_type":"a","double_decker":false,"length":25,"coach_class":1,"coach_number":1,"amenities":"f","start":20,"stop":45},{"coach_type":"m","double_decker":false,"length":25,"coach_class":2,"coach_number":2,"amenities":"r","start":45,"stop":70},{"coach_type":"e","double_decker":false,"length":20,"coach_class":2,"coach_number":3,"amenities":"g","start":70,"stop":90}]</textarea></label>
        <button id="zug1-export-wagenreihung">Export Wagenreihung</button>
        <button id="zug1-import-wagenreihung">Import Wagenreihung <input type="file" id="zug1-file" style="display:none;"></button>
    </section>

    <!-- Zug 2 -->
    <section>
        <h2>Daten Zug 2 (Small)</h2>
        <label>Zuglinie/Zugnummer: <input id="zug2-zugnummer" type="text" value="RE 456"></label>
        <label>Abfahrt: <input id="zug2-abfahrt" type="text" value="13:45"></label>
        <label>Abweichend: <input id="zug2-abweichend" type="text" value=""></label>
        <label>Ziel: <input id="zug2-ziel" type="text" value="Munich"></label>
        <label>Via-Halte 1 Small: <input id="zug2-via1-small" type="text" value="Nuremberg"></label>
        <label>Via-Halte 2 Small: <input id="zug2-via2-small" type="text" value="Augsburg"></label>
        <label>Via-Halte 3 Small: <input id="zug2-via3-small" type="text" value=""></label>
        <label>Informationen: <input id="zug2-informationen" type="text" value="Short info"></label>
        <label>Richtung: <input type="radio" name="zug2-richtung" value="0"> Links <input type="radio" name="zug2-richtung" value="1" checked> Rechts</label>
        <label>Startmeter: <input id="zug2-startmeter" type="number" value="0"></label>
        <label>Skalieren: <input id="zug2-skalieren" type="checkbox"></label>
        <label>Gleiswechsel: <input id="zug2-gleiswechsel" type="text" value="0"></label>
        <label>Wagenreihung (JSON): <textarea id="zug2-wagenreihung" rows="5">[{"coach_type":"a","double_decker":false,"length":25,"coach_class":2,"coach_number":4,"amenities":"","start":0,"stop":25},{"coach_type":"e","double_decker":false,"length":25,"coach_class":2,"coach_number":5,"amenities":"m","start":25,"stop":50}]</textarea></label>
        <button id="zug2-export-wagenreihung">Export Wagenreihung</button>
        <button id="zug2-import-wagenreihung">Import Wagenreihung <input type="file" id="zug2-file" style="display:none;"></button>
    </section>

    <!-- Zug 3 -->
    <section>
        <h2>Daten Zug 3 (Small with Gleiswechsel)</h2>
        <label>Zuglinie/Zugnummer: <input id="zug3-zugnummer" type="text" value="S 789"></label>
        <label>Abfahrt: <input id="zug3-abfahrt" type="text" value="14:56"></label>
        <label>Abweichend: <input id="zug3-abweichend" type="text" value="15:00"></label>
        <label>Ziel: <input id="zug3-ziel" type="text" value="Frankfurt"></label>
        <label>Via-Halte 1 Small: <input id="zug3-via1-small" type="text" value="Mannheim"></label>
        <label>Via-Halte 2 Small: <input id="zug3-via2-small" type="text" value="Darmstadt"></label>
        <label>Via-Halte 3 Small: <input id="zug3-via3-small" type="text" value=""></label>
        <label>Informationen: <input id="zug3-informationen" type="text" value="Very long information that scrolls across the screen repeatedly for testing performance in high resolution canvas rendering."></label>
        <label>Richtung: <input type="radio" name="zug3-richtung" value="0"> Links <input type="radio" name="zug3-richtung" value="1" checked> Rechts</label>
        <label>Startmeter: <input id="zug3-startmeter" type="number" value="0"></label>
        <label>Skalieren: <input id="zug3-skalieren" type="checkbox"></label>
        <label>Gleiswechsel: <input id="zug3-gleiswechsel" type="text" value="2"></label>
        <label>Wagenreihung (JSON): <textarea id="zug3-wagenreihung" rows="5">[{"coach_type":"l","double_decker":false,"length":20,"coach_class":0,"coach_number":0,"amenities":"","start":0,"stop":20},{"coach_type":"ma","double_decker":false,"length":25,"coach_class":1,"coach_number":6,"amenities":"f","start":20,"stop":45},{"coach_type":"me","double_decker":false,"length":25,"coach_class":2,"coach_number":7,"amenities":"","start":45,"stop":70}]</textarea></label>
        <button id="zug3-export-wagenreihung">Export Wagenreihung</button>
        <button id="zug3-import-wagenreihung">Import Wagenreihung <input type="file" id="zug3-file" style="display:none;"></button>
    </section>

    <!-- Previews -->
    <div>
        <h2>Preview Full Screen (Zug 1)</h2>
        <div id="preview-full-container" class="preview-container"></div>
    </div>
    <div class="small-previews">
        <div>
            <h2>Preview Small Zug 2</h2>
            <div id="preview-small1-container" class="preview-container"></div>
        </div>
        <div>
            <h2>Preview Small Zug 3</h2>
            <div id="preview-small2-container" class="preview-container"></div>
        </div>
    </div>
    <button id="download-highres">Download High-Res Image (Full Screen)</button>

    <script>
        class Coach {
            constructor(coach_type, double_decker, length, coach_class, coach_number, amenities, start, stop) {
                this.coach_type = coach_type;
                this.double_decker = double_decker;
                this.length = length;
                this.coach_class = coach_class;
                this.coach_number = coach_number;
                this.amenities = amenities;
                this.start = start;
                this.stop = stop;
            }

            is_first_class() {
                return [1, 12, 21].includes(this.coach_class);
            }

            is_locomotive() {
                return this.coach_type === 'l';
            }

            has_amenity(a) {
                return this.amenities.includes(a);
            }
        }

        class TrainDisplay {
            constructor() {
                this.y = 35;
                this.speed = 2;
                this.aktuelles_merkmal = "wagennummern";
                this.merkmale = ["wagennummern", "ausstattung", "klasse"];
                this.rotations_index = 0;
                this.rotation_timer = null;
                this.rotating = false;
                this.scroll_offscreens = {}; // zug_nr -> offscreen canvas for text
                this.scroll_positions = {}; // zug_nr -> current pos
                this.scroll_animation_ids = {}; // zug_nr -> raf id
                this.overlay_ctxs = {}; // zug_nr -> overlay ctx
            }

            print_direction(richtung, x, ctx, scale = 1) {
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2 * scale;
                x *= scale;
                const y = this.y * scale;
                if (richtung === 0) {
                    ctx.beginPath(); ctx.moveTo(x, y + 20 * scale); ctx.lineTo(x + 10 * scale, y + 10 * scale); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(x, y + 20 * scale); ctx.lineTo(x + 15 * scale, y + 20 * scale); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(x, y + 20 * scale); ctx.lineTo(x + 10 * scale, y + 30 * scale); ctx.stroke();
                } else {
                    ctx.beginPath(); ctx.moveTo(x + 15 * scale, y + 20 * scale); ctx.lineTo(x + 5 * scale, y + 10 * scale); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(x + 15 * scale, y + 20 * scale); ctx.lineTo(x, y + 20 * scale); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(x + 15 * scale, y + 20 * scale); ctx.lineTo(x + 5 * scale, y + 30 * scale); ctx.stroke();
                }
            }

            print_start_wagon(coach, x, ctx, scale = 1) {
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 3 * scale;
                x *= scale;
                const y = this.y * scale;
                ctx.beginPath(); ctx.moveTo(x, y + 40 * scale + 2 * scale); ctx.lineTo(x, y + 10 * scale); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(x, y + 10 * scale); ctx.lineTo(x + 6 * scale, y); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(x + 6 * scale, y); ctx.lineTo(x + coach.length * scale, y); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(x, y + 40 * scale); ctx.lineTo(x + coach.length * scale, y + 40 * scale); ctx.stroke();
            }

            print_middle_wagon(coach, x, ctx, scale = 1) {
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 3 * scale;
                x *= scale;
                const y = this.y * scale;
                ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x + coach.length * scale, y); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(x, y + 40 * scale); ctx.lineTo(x + coach.length * scale, y + 40 * scale); ctx.stroke();
                if (coach.coach_type === 'ma') {
                    ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x, y + 40 * scale + 2 * scale); ctx.stroke();
                } else if (coach.coach_type === 'me') {
                    ctx.beginPath(); ctx.moveTo(x + coach.length * scale, y); ctx.lineTo(x + coach.length * scale, y + 40 * scale + 2 * scale); ctx.stroke();
                }
            }

            print_end_wagon(coach, x, ctx, scale = 1) {
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 3 * scale;
                x *= scale;
                const y = this.y * scale;
                ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x + coach.length * scale - 6 * scale, y); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(x + coach.length * scale - 6 * scale, y); ctx.lineTo(x + coach.length * scale, y + 10 * scale); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(x + coach.length * scale, y + 10 * scale); ctx.lineTo(x + coach.length * scale, y + 40 * scale + 2 * scale); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(x, y + 40 * scale); ctx.lineTo(x + coach.length * scale, y + 40 * scale); ctx.stroke();
            }

            print_locomotive(coach, x, ctx, scale = 1) {
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 3 * scale;
                x *= scale;
                const y = this.y * scale;
                ctx.beginPath(); ctx.moveTo(x, y + 40 * scale + 2 * scale); ctx.lineTo(x, y + 16 * scale); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(x, y + 16 * scale); ctx.lineTo(x + 4 * scale, y + 8 * scale); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(x + 4 * scale, y + 8 * scale); ctx.lineTo(x + coach.length * scale - 4 * scale, y + 8 * scale); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(x + coach.length * scale - 4 * scale, y + 8 * scale); ctx.lineTo(x + coach.length * scale, y + 16 * scale); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(x + coach.length * scale, y + 16 * scale); ctx.lineTo(x + coach.length * scale, y + 40 * scale + 2 * scale); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(x, y + 40 * scale); ctx.lineTo(x + coach.length * scale, y + 40 * scale); ctx.stroke();
            }

            print_first_class(coach, x, ctx, fullScreen, scale = 1) {
                if (coach.is_first_class()) {
                    ctx.fillStyle = 'orange';
                    x *= scale;
                    const y = this.y * scale;
                    let width = coach.length * scale;
                    if (!fullScreen) {
                        if (coach.coach_type === 'e') width += 2 * scale;
                        if (coach.coach_type === 'a') width -= 2 * scale;
                    }
                    ctx.fillRect(x, y + 46 * scale, width, 10 * scale);
                }
            }

            print_class(coach, x, ctx, scale = 1) {
                ctx.font = `bold ${16 * scale}px "Open Sans Condensed"`;
                ctx.textAlign = 'center';
                x = (x + (coach.length / 2)) * scale;
                const y = this.y * scale + 20 * scale;
                if (coach.is_first_class()) {
                    ctx.fillStyle = 'orange';
                    ctx.fillText("1.", x, y);
                } else if (coach.coach_class === 2 && !coach.is_locomotive()) {
                    ctx.fillStyle = 'white';
                    ctx.fillText("2.", x, y);
                }
            }

            print_class_compact(coaches, ctx, scale = 1) {
                let group = [];
                const process_group = () => {
                    if (!group.length) return;
                    const first_coach = group[0][0];
                    const start_pos = group[0][1] * scale;
                    const end_pos = (group[group.length - 1][0].start + group[group.length - 1][0].length) * scale;
                    const center = (start_pos + end_pos) / 2;
                    const current_class = first_coach.coach_class;
                    ctx.font = `bold ${16 * scale}px "Open Sans Condensed"`;
                    ctx.textAlign = 'center';
                    const y = this.y * scale + 20 * scale;
                    if (current_class === 1) {
                        ctx.fillStyle = 'orange';
                        ctx.fillText("1.", center, y);
                    } else if (current_class === 2) {
                        ctx.fillStyle = 'white';
                        ctx.fillText("2.", center, y);
                    }
                };
                for (let coach of coaches) {
                    if (['a', 'ma', 'm'].includes(coach.coach_type)) {
                        if (!group.length || coach.coach_class === group[0][0].coach_class) {
                            group.push([coach, coach.start]);
                        } else {
                            process_group();
                            group = [[coach, coach.start]];
                        }
                    } else if (['e', 'me'].includes(coach.coach_type)) {
                        if (group.length && coach.coach_class === group[0][0].coach_class) {
                            group.push([coach, coach.start]);
                        } else if (group.length) {
                            process_group();
                            group = [[coach, coach.start]];
                        } else {
                            group = [[coach, coach.start]];
                        }
                        process_group();
                        group = [];
                    } else {
                        if (group.length) process_group();
                        group = [];
                    }
                }
                if (group.length) process_group();
            }

            print_amenities(coach, x, ctx, scale = 1) {
                ctx.font = `${16 * scale}px sans-serif`;
                ctx.textAlign = 'center';
                x = (x + (coach.length / 2)) * scale;
                const y = this.y * scale + 20 * scale;
                let amenity = '';
                if (coach.has_amenity('f')) amenity = 'F';
                else if (coach.has_amenity('r')) amenity = 'R';
                else if (coach.has_amenity('m')) amenity = 'M';
                else if (coach.has_amenity('g')) amenity = 'G';
                if (amenity) {
                    ctx.fillStyle = 'white';
                    ctx.fillText(amenity, x, y);
                }
            }

            print_amenities_compact(coaches, ctx, scale = 1) {
                let group = [];
                const positions = [];
                const process_group = () => {
                    if (!group.length) return;
                    const first_coach = group[0][0];
                    const last_coach = group[group.length - 1][0];
                    const start_pos = group[0][1] * scale;
                    const end_pos = (last_coach.start + last_coach.length) * scale;
                    let center = (start_pos + end_pos) / 2;
                    const amenity = first_coach.amenities;
                    const y = this.y * scale + 20 * scale;
                    let shift = 0;
                    if (amenity) {
                        if (last_coach.coach_type === 'a') shift = 0;
                        else if (last_coach.coach_type === 'e') shift = 0;
                        center += shift * scale;
                        const min_dist = 20 * scale;
                        const prev_pos = positions[positions.length - 1];
                        if (prev_pos && center - prev_pos < min_dist) center = prev_pos + min_dist;
                        positions.push(center);
                        ctx.font = `${16 * scale}px sans-serif`;
                        ctx.textAlign = 'center';
                        ctx.fillStyle = 'white';
                        ctx.fillText(amenity.toUpperCase(), center, y);
                    }
                };
                for (let coach of coaches) {
                    if (['a', 'ma', 'm'].includes(coach.coach_type)) {
                        if (!group.length || coach.amenities === group[0][0].amenities) {
                            group.push([coach, coach.start]);
                        } else {
                            process_group();
                            group = [[coach, coach.start]];
                        }
                    } else if (['e', 'me'].includes(coach.coach_type)) {
                        if (group.length && coach.amenities === group[0][0].amenities) {
                            group.push([coach, coach.start]);
                        } else if (group.length) {
                            process_group();
                            group = [[coach, coach.start]];
                        } else {
                            group = [[coach, coach.start]];
                        }
                        process_group();
                        group = [];
                    } else {
                        if (group.length) process_group();
                        group = [];
                    }
                }
                if (group.length) process_group();
            }

            print_wagon_numbers(coach, x, ctx, scale = 1) {
                if (coach.coach_number !== 0) {
                    ctx.fillStyle = 'white';
                    ctx.font = `${16 * scale}px "Open Sans Condensed"`;
                    ctx.textAlign = 'center';
                    ctx.fillText(coach.coach_number.toString(), (x + (coach.length / 2)) * scale, this.y * scale + 20 * scale);
                }
            }

            print_wagon_numbers_compact(coaches, ctx, scale = 1) {
                let group = [];
                const positions = [];
                for (let coach of coaches) {
                    if (coach.coach_number !== 0) {
                        group.push([coach, coach.start]);
                        if (['e', 'me', 'l'].includes(coach.coach_type)) {
                            if (group.length) {
                                const first_coach = group[0][0];
                                const last_coach = group[group.length - 1][0];
                                const start_pos = group[0][1] * scale;
                                const end_pos = (last_coach.start + last_coach.length) * scale;
                                let center = (start_pos + end_pos) / 2;
                                const first_number = first_coach.coach_number;
                                const last_number = last_coach.coach_number;
                                let number_text = first_number === last_number ? first_number.toString() : `${first_number} - ${last_number}`;
                                if (number_text !== "0") {
                                    ctx.fillStyle = 'white';
                                    ctx.font = `${16 * scale}px "Open Sans Condensed"`;
                                    ctx.textAlign = 'center';
                                    const text_width = ctx.measureText(number_text).width;
                                    const min_dist = text_width + 10 * scale;
                                    const prev_pos = positions[positions.length - 1];
                                    if (prev_pos && center - prev_pos < min_dist) center = prev_pos + min_dist;
                                    positions.push(center);
                                    ctx.fillText(number_text, center, this.y * scale + 20 * scale);
                                }
                                group = [];
                            }
                        }
                    } else if (group.length && ['e', 'me', 'l'].includes(coach.coach_type)) {
                        const first_coach = group[0][0];
                        const last_coach = group[group.length - 1][0];
                        const start_pos = group[0][1] * scale;
                        const end_pos = (last_coach.start + last_coach.length) * scale;
                        let center = (start_pos + end_pos) / 2;
                        const first_number = first_coach.coach_number;
                        const last_number = last_coach.coach_number;
                        let number_text = first_number === last_number ? first_number.toString() : `${first_number} - ${last_number}`;
                        if (number_text !== "0") {
                            ctx.fillStyle = 'white';
                            ctx.font = `${16 * scale}px "Open Sans Condensed"`;
                            ctx.textAlign = 'center';
                            const text_width = ctx.measureText(number_text).width;
                            const min_dist = text_width + 10 * scale;
                            const prev_pos = positions[positions.length - 1];
                            if (prev_pos && center - prev_pos < min_dist) center = prev_pos + min_dist;
                            positions.push(center);
                            ctx.fillText(number_text, center, this.y * scale + 20 * scale);
                        }
                        group = [];
                    }
                }
            }

            print_sectors(sectors, ctx, fullScreen, scale_factor, platform_length, scale = 1) {
                const threshold = (fullScreen ? 50 : 25) * scale;
                ctx.fillStyle = 'white';
                ctx.font = `${16 * scale}px "Open Sans Condensed"`;
                ctx.textAlign = 'center';
                for (let [name, position] of sectors) {
                    const display_pos = threshold + 25 * scale + position * scale_factor * scale;
                    ctx.fillText(name, display_pos, 10 * scale);
                }
            }

            print_coach_sequence(coaches, ctx, gleiswechsel = "0", fullScreen = true, richtung = 1, platform_length = 420, start_meter = 0, skalieren = false, usable_display_length = 840, scale = 1) {
                const factor = fullScreen ? 2 : 1;
                let bahnsteiglaenge_display = 470 * factor * scale;
                const threshold = (fullScreen ? 50 : 25) * scale;
                usable_display_length *= scale;
                const gap = 2 * scale;
                let zuglaenge = coaches.reduce((sum, coach) => sum + coach.length, 0);
                if (!fullScreen) zuglaenge -= coaches.reduce((sum, coach) => sum + (coach.is_locomotive() ? coach.length : 0), 0);

                let factor_new = usable_display_length / platform_length;

                let display_coaches = fullScreen ? coaches : coaches.filter(coach => !coach.is_locomotive());
                if (!display_coaches.length) return;

                if (!fullScreen) {
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = scale;
                    ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(0, 129 * scale); ctx.stroke();
                }

                let min_start = display_coaches.reduce((min, coach) => Math.min(min, coach.start), Infinity);
                min_start = 0;

                let scaled_coaches = display_coaches.map(coach => {
                    const new_start = (coach.start + min_start) * factor_new + threshold / scale + 25;
                    const new_stop = (coach.stop + min_start) * factor_new + threshold / scale + 25;
                    const new_length = coach.length * factor_new;
                    return new Coach(coach.coach_type, coach.double_decker, new_length, coach.coach_class, coach.coach_number, coach.amenities, new_start, new_stop);
                });

                for (let i = 0; i < scaled_coaches.length - 1; i++) {
                    scaled_coaches[i].length = scaled_coaches[i + 1].start - scaled_coaches[i].start;
                }
                scaled_coaches[scaled_coaches.length - 1].length = scaled_coaches[scaled_coaches.length - 1].stop - scaled_coaches[scaled_coaches.length - 1].start;

                scaled_coaches.forEach(coach => {
                    if (gap > 0) {
                        if (fullScreen) {
                            coach.length -= gap * 2 / scale;
                            coach.start += gap / scale;
                        } else {
                            if (['a', 'ma'].includes(coach.coach_type)) coach.start += gap / scale;
                            else if (['e', 'me'].includes(coach.coach_type)) coach.length -= gap / scale;
                        }
                    }
                });

                let zuglaenge_scaled = scaled_coaches.reduce((sum, coach) => sum + coach.length, 0);

                if (zuglaenge_scaled < usable_display_length / 2 / scale && skalieren) {
                    factor_new *= 2;
                    scaled_coaches = display_coaches.map(coach => {
                        const new_start = coach.start * factor_new + threshold / scale;
                        const new_stop = coach.stop * factor_new + threshold / scale;
                        const new_length = coach.length * factor_new;
                        return new Coach(coach.coach_type, coach.double_decker, new_length, coach.coach_class, coach.coach_number, coach.amenities, new_start, new_stop);
                    });
                    for (let i = 0; i < scaled_coaches.length - 1; i++) {
                        scaled_coaches[i].length = scaled_coaches[i + 1].start - scaled_coaches[i].start;
                    }
                    scaled_coaches[scaled_coaches.length - 1].length = scaled_coaches[scaled_coaches.length - 1].stop - scaled_coaches[scaled_coaches.length - 1].start;
                    zuglaenge_scaled = scaled_coaches.reduce((sum, coach) => sum + coach.length, 0);
                }

                const start_meter_pixel = scaled_coaches.reduce((min, coach) => Math.min(min, coach.start), Infinity) * scale;

                if (richtung === 0) {
                    this.print_direction(richtung, (start_meter_pixel / scale - 20), ctx, scale);
                }

                ctx.strokeStyle = 'white';
                ctx.lineWidth = 3 * scale;
                ctx.beginPath(); ctx.moveTo(threshold, 75 * scale); ctx.lineTo(start_meter_pixel - 5 * scale, 75 * scale); ctx.stroke();

                let coach_start_positions = [];
                scaled_coaches.forEach(coach => {
                    if (coach.coach_type === 'a') this.print_start_wagon(coach, coach.start, ctx, scale);
                    else if (coach.coach_type.startsWith('m')) this.print_middle_wagon(coach, coach.start, ctx, scale);
                    else if (coach.coach_type === 'e') this.print_end_wagon(coach, coach.start, ctx, scale);
                    else if (coach.coach_type === 'l' && fullScreen) this.print_locomotive(coach, coach.start, ctx, scale);

                    this.print_first_class(coach, coach.start, ctx, fullScreen, scale);
                    if (this.aktuelles_merkmal === "klasse" && fullScreen) this.print_class(coach, coach.start, ctx, scale);
                    else if (this.aktuelles_merkmal === "ausstattung" && fullScreen) this.print_amenities(coach, coach.start, ctx, scale);
                    else if (this.aktuelles_merkmal === "wagennummern" && fullScreen) this.print_wagon_numbers(coach, coach.start, ctx, scale);

                    coach_start_positions.push((coach.start + coach.length) * scale);
                });

                if (!fullScreen) {
                    if (this.aktuelles_merkmal === "klasse") this.print_class_compact(scaled_coaches, ctx, scale);
                    else if (this.aktuelles_merkmal === "ausstattung") this.print_amenities_compact(scaled_coaches, ctx, scale);
                    else if (this.aktuelles_merkmal === "wagennummern") this.print_wagon_numbers_compact(scaled_coaches, ctx, scale);
                }

                const right_pos = Math.max(...coach_start_positions);
                ctx.beginPath(); ctx.moveTo(right_pos + 5 * scale, 75 * scale); ctx.lineTo(bahnsteiglaenge_display - threshold, 75 * scale); ctx.stroke();

                if (richtung === 1) this.print_direction(richtung, (right_pos / scale + 5), ctx, scale);

                return factor_new;
            }

            print_pictograms(ctx, zug_nr, fullScreen, info, nr, scale = 1, overlay_ctx) {
                let x = (fullScreen ? 75 : 50) * scale;
                const step = 55 * scale;
                const icon_y = 25 * scale;
                if (info.includes("Zug fällt heute aus") || info.includes("Keine Weiterfahrt nach")) {
                    ctx.fillStyle = 'yellow';
                    ctx.fillRect(x, icon_y - 25 * scale, 50 * scale, 50 * scale);
                    ctx.fillStyle = 'black';
                    ctx.font = `${20 * scale}px sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.fillText('Ausfall', x + 25 * scale, icon_y);
                    x += step;
                }
                if (nr.includes("FLX")) {
                    ctx.fillStyle = 'yellow';
                    ctx.fillRect(x, icon_y - 25 * scale, 50 * scale, 50 * scale);
                    ctx.fillStyle = 'black';
                    ctx.font = `${20 * scale}px sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.fillText('ResPf', x + 25 * scale, icon_y);
                    x += step;
                }
                if (nr.includes("IC")) {
                    ctx.fillStyle = 'yellow';
                    ctx.fillRect(x, icon_y - 25 * scale, 50 * scale, 50 * scale);
                    ctx.fillStyle = 'black';
                    ctx.font = `${20 * scale}px sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.fillText('FahRes', x + 25 * scale, icon_y);
                    x += step;
                }
                if (info.includes("Heute mit Halt in")) {
                    ctx.fillStyle = 'yellow';
                    ctx.fillRect(x, icon_y - 25 * scale, 50 * scale, 50 * scale);
                    ctx.fillStyle = 'black';
                    ctx.font = `${20 * scale}px sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.fillText('ZusHalt', x + 25 * scale, icon_y);
                    x += step;
                }
                if (info.includes("Heute ohne Halt in")) {
                    ctx.fillStyle = 'yellow';
                    ctx.fillRect(x, icon_y - 25 * scale, 50 * scale, 50 * scale);
                    ctx.fillStyle = 'black';
                    ctx.font = `${20 * scale}px sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.fillText('HaltEnt', x + 25 * scale, icon_y);
                    x += step;
                }
                if (info.includes("Mehrere Wagen fehlen") || info.includes("Ein Wagen fehlt")) {
                    ctx.fillStyle = 'yellow';
                    ctx.fillRect(x, icon_y - 25 * scale, 50 * scale, 50 * scale);
                    ctx.fillStyle = 'black';
                    ctx.font = `${20 * scale}px sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.fillText('WagFehl', x + 25 * scale, icon_y);
                    x += step;
                }
                if (info.includes("Kein gastronomisches Angebot")) {
                    ctx.fillStyle = 'yellow';
                    ctx.fillRect(x, icon_y - 25 * scale, 50 * scale, 50 * scale);
                    ctx.fillStyle = 'black';
                    ctx.font = `${20 * scale}px sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.fillText('KeinGastro', x + 25 * scale, icon_y);
                    x += step;
                }

                const canvas_width = fullScreen ? 940 * scale : 470 * scale;
                const scroll_width = canvas_width - x;
                if (info) {
                    ctx.font = `${23 * scale}px "Open Sans Condensed"`;
                    const text_width = ctx.measureText(info).width;
                    if (text_width > scroll_width) {
                        let result = '';
                        for (let i = 0; i < Math.floor(10000 / info.length); i++) {
                            result += info + ' +++ ';
                        }
                        this.init_scrolling_text(zug_nr, overlay_ctx, result, scroll_width, scale);
                    } else {
                        ctx.fillStyle = 'midnightblue';
                        ctx.textAlign = 'left';
                        ctx.fillText(info, x, 25 * scale);
                    }
                }
                return x;
            }

            init_scrolling_text(zug_nr, overlay_ctx, text, scroll_width, scale) {
                if (this.scroll_animation_ids[zug_nr]) cancelAnimationFrame(this.scroll_animation_ids[zug_nr]);
                const text_width = overlay_ctx.measureText(text).width;
                const offscreen = document.createElement('canvas');
                offscreen.width = text_width;
                offscreen.height = 50 * scale;
                const off_ctx = offscreen.getContext('2d');
                off_ctx.font = `${23 * scale}px "Open Sans Condensed"`;
                off_ctx.fillStyle = 'midnightblue';
                off_ctx.textAlign = 'left';
                off_ctx.textBaseline = 'middle';
                off_ctx.fillText(text, 0, 25 * scale);
                this.scroll_offscreens[zug_nr] = offscreen;
                this.scroll_positions[zug_nr] = 0;
                overlay_ctx.canvas.width = scroll_width;
                overlay_ctx.canvas.height = 50 * scale;
                this.animate_scroll(zug_nr, overlay_ctx, scale);
            }

            animate_scroll(zug_nr, overlay_ctx, scale) {
                const offscreen = this.scroll_offscreens[zug_nr];
                let pos = this.scroll_positions[zug_nr];
                const width = overlay_ctx.canvas.width;
                const height = overlay_ctx.canvas.height;
                const text_width = offscreen.width;
                overlay_ctx.clearRect(0, 0, width, height);
                overlay_ctx.drawImage(offscreen, pos, 0);
                overlay_ctx.drawImage(offscreen, pos - text_width, 0);
                pos += this.speed * scale;
                if (pos >= text_width) pos = 0;
                this.scroll_positions[zug_nr] = pos;
                this.scroll_animation_ids[zug_nr] = requestAnimationFrame(() => this.animate_scroll(zug_nr, overlay_ctx, scale));
            }

            print_train_info(info, nr, nr_kurz, abfahrt, abfahrt_a, ziel, via, via2, via3, gleiswechsel, ctx, fullScreen, scale = 1, overlay_ctx, zug_nr) {
                if (fullScreen) {
                    if (nr) {
                        ctx.fillStyle = 'white';
                        ctx.font = `${40 * scale}px "Open Sans Condensed"`;
                        ctx.textAlign = 'right';
                        const text_x = 890 * scale;
                        const text_y = 105 * scale;
                        ctx.fillText(nr, text_x, text_y);
                        const text_width = ctx.measureText(nr).width;
                        const text_height = 40 * scale;
                        ctx.fillStyle = 'grey';
                        ctx.fillRect(text_x - text_width - 10 * scale, text_y - text_height / 2 - 10 * scale, text_width + 20 * scale, text_height + 20 * scale);
                    }
                    ctx.font = `${70 * scale}px "Open Sans Condensed"`;
                    ctx.textAlign = 'left';
                    ctx.fillStyle = 'white';
                    ctx.fillText(abfahrt, 50 * scale, 103 * scale);

                    if (abfahrt_a) {
                        ctx.font = `${50 * scale}px "Open Sans Condensed"`;
                        ctx.fillStyle = 'midnightblue';
                        ctx.fillText(abfahrt_a, 270 * scale, 105 * scale);
                        const text_width = ctx.measureText(abfahrt_a).width;
                        const text_height = 50 * scale;
                        ctx.fillStyle = 'white';
                        ctx.fillRect(270 * scale - 10 * scale, 105 * scale - text_height / 2 - 10 * scale, text_width + 20 * scale, text_height + 20 * scale);
                    }
                    ctx.font = `${72 * scale}px "Open Sans Condensed"`;
                    ctx.fillStyle = 'white';
                    ctx.fillText(ziel, 50 * scale, 210 * scale);
                    ctx.font = `${25 * scale}px "Open Sans Condensed"`;
                    ctx.fillText(via, 56 * scale, 310 * scale);
                    ctx.fillText(via2, 56 * scale, 360 * scale);
                } else {
                    nr = nr_kurz;
                    if (nr) {
                        ctx.strokeStyle = 'white';
                        ctx.lineWidth = scale;
                        ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(0, 410 * scale); ctx.stroke();
                        ctx.beginPath(); ctx.moveTo(469 * scale, 0); ctx.lineTo(469 * scale, 400 * scale); ctx.stroke();
                        ctx.font = `${28 * scale}px "Open Sans Condensed"`;
                        ctx.textAlign = 'right';
                        ctx.fillStyle = 'white';
                        ctx.fillText(nr, 445 * scale, 100 * scale);
                        const text_width = ctx.measureText(nr).width;
                        const text_height = 28 * scale;
                        ctx.fillStyle = 'grey';
                        ctx.fillRect(445 * scale - text_width - 5 * scale, 100 * scale - text_height / 2 - 5 * scale, text_width + 10 * scale, text_height + 10 * scale);
                    }
                    ctx.font = `${38 * scale}px "Open Sans Condensed"`;
                    ctx.textAlign = 'left';
                    ctx.fillStyle = 'white';
                    ctx.fillText(abfahrt, 25 * scale, 100 * scale);

                    if (abfahrt_a) {
                        ctx.font = `${28 * scale}px "Open Sans Condensed"`;
                        ctx.fillStyle = 'midnightblue';
                        ctx.fillText(abfahrt_a, 145 * scale, 100 * scale);
                        const text_width = ctx.measureText(abfahrt_a).width;
                        const text_height = 28 * scale;
                        ctx.fillStyle = 'white';
                        ctx.fillRect(145 * scale - 10 * scale, 100 * scale - text_height / 2 - 10 * scale, text_width + 20 * scale, text_height + 20 * scale);
                    }
                    ctx.font = `${34 * scale}px "Open Sans Condensed"`;
                    ctx.fillStyle = 'white';
                    ctx.fillText(ziel, 25 * scale, 180 * scale);
                    ctx.font = `${25 * scale}px "Open Sans Condensed"`;
                    ctx.fillText(via, 28 * scale, 260 * scale);
                    ctx.fillText(via2, 28 * scale, 310 * scale);
                    ctx.fillText(via3, 28 * scale, 360 * scale);

                    if (gleiswechsel !== "0" && ctx.canvas.parentNode.id === 'preview-small2-container') {
                        ctx.fillStyle = 'orange';
                        ctx.fillRect(0, 0, 470 * scale, 50 * scale);
                        ctx.fillStyle = 'white';
                        ctx.font = `${20 * scale}px "Open Sans Condensed"`;
                        ctx.textAlign = 'left';
                        ctx.fillText('Gleisänderung / ', 25 * scale, 25 * scale);
                        ctx.font = `italic ${20 * scale}px "Open Sans Condensed"`;
                        ctx.fillText('Track change', 210 * scale, 25 * scale);

                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 50 * scale, 470 * scale, 350 * scale);
                        if (nr) {
                            ctx.strokeStyle = 'white';
                            ctx.lineWidth = scale;
                            ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(0, 410 * scale); ctx.stroke();
                            ctx.font = `${28 * scale}px "Open Sans Condensed"`;
                            ctx.textAlign = 'right';
                            ctx.fillStyle = 'white';
                            ctx.fillText(nr, 445 * scale, 100 * scale);
                            const text_width = ctx.measureText(nr).width;
                            const text_height = 28 * scale;
                            ctx.fillStyle = 'grey';
                            ctx.fillRect(445 * scale - text_width - 5 * scale, 100 * scale - text_height / 2 - 5 * scale, text_width + 10 * scale, text_height + 10 * scale);
                        }
                        ctx.font = `${38 * scale}px "Open Sans Condensed"`;
                        ctx.fillStyle = 'midnightblue';
                        ctx.textAlign = 'left';
                        ctx.fillText(abfahrt, 25 * scale, 100 * scale);
                        if (abfahrt_a) {
                            ctx.font = `${28 * scale}px "Open Sans Condensed"`;
                            ctx.fillStyle = 'white';
                            ctx.fillText(abfahrt_a, 145 * scale, 100 * scale);
                            const text_width = ctx.measureText(abfahrt_a).width;
                            const text_height = 28 * scale;
                            ctx.fillStyle = 'midnightblue';
                            ctx.fillRect(145 * scale - 10 * scale, 100 * scale - text_height / 2 - 10 * scale, text_width + 20 * scale, text_height + 20 * scale);
                        }
                        ctx.font = `${34 * scale}px "Open Sans Condensed"`;
                        ctx.fillStyle = 'midnightblue';
                        ctx.fillText(ziel, 25 * scale, 180 * scale);
                        ctx.font = `${25 * scale}px "Open Sans Condensed"`;
                        ctx.fillText(via, 25 * scale, 260 * scale);
                        ctx.fillText(via2, 25 * scale, 310 * scale);
                        ctx.fillText(via3, 25 * scale, 360 * scale);
                    }
                }
                const scroll_start_x = this.print_pictograms(ctx, zug_nr, fullScreen, info, nr, scale, overlay_ctx);
                return scroll_start_x;
            }

            start_feature_rotation() {
                if (!this.rotating) return;
                this.aktuelles_merkmal = this.merkmale[this.rotations_index];
                this.rotations_index = (this.rotations_index + 1) % this.merkmale.length;
                updateDisplays();
                if (this.rotating) this.rotation_timer = setTimeout(() => this.start_feature_rotation(), 3000);
            }

            on_feature_button_change(value) {
                if (value === "rotierend") {
                    this.rotating = true;
                    if (this.rotation_timer) clearTimeout(this.rotation_timer);
                    this.start_feature_rotation();
                } else {
                    this.rotating = false;
                    if (this.rotation_timer) clearTimeout(this.rotation_timer);
                    this.aktuelles_merkmal = value;
                    updateDisplays();
                }
            }

            cleanup() {
                if (this.rotation_timer) clearTimeout(this.rotation_timer);
                this.rotating = false;
                Object.keys(this.scroll_animation_ids).forEach(id => cancelAnimationFrame(this.scroll_animation_ids[id]));
            }

            update_coach_sequence(zug_nr, ctx, fullScreen, scale = 1) {
                const data = getTrainData(zug_nr);
                const coaches = data["Wagenreihung"] || [];
                const platform_length = data["PlatformLength"] || 420;
                const platform_sections = [['A', 69.7], ['B', 135.8], ['C', 208], ['D', 266], ['E', 315.65]];
                const train_start = data["Startmeter"] || 0;
                const direction = data["Richtung"] || 1;
                const gleiswechsel = data["Gleiswechsel"] || "0";
                const skalieren = data["Skalieren"] || false;

                if (coaches.length) {
                    const factor_new = this.print_coach_sequence(
                        coaches, ctx, gleiswechsel, fullScreen, direction, platform_length, train_start, skalieren, fullScreen ? 840 : 370, scale
                    );
                    if (platform_sections) this.print_sectors(platform_sections, ctx, fullScreen, factor_new, platform_length, scale);
                } else if (!fullScreen && data["Zugnummer"]) {
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = scale;
                    ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(0, 129 * scale); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(469 * scale, 0); ctx.lineTo(469 * scale, 129 * scale); ctx.stroke();
                }

                if (gleiswechsel !== "0" && ctx.canvas.parentNode.id === 'preview-small2-container') {
                    ctx.fillStyle = 'orange';
                    ctx.fillRect(0, 0, 470 * scale, 129 * scale);
                    ctx.fillStyle = 'white';
                    ctx.font = `${20 * scale}px "Open Sans Condensed"`;
                    ctx.textAlign = 'left';
                    ctx.fillText('Neues Gleis', 25 * scale, 25 * scale);
                    ctx.font = `italic ${20 * scale}px "Open Sans Condensed"`;
                    ctx.fillText('New Track', 25 * scale, 55 * scale);
                    ctx.font = `${42 * scale}px "Open Sans Condensed"`;
                    ctx.textAlign = 'right';
                    ctx.fillText(gleiswechsel, 445 * scale, 40 * scale);
                }
            }

            update_train_display(zug_nr, main_ctx, overlay_ctx, fullScreen, scale) {
                main_ctx.fillStyle = 'black';
                main_ctx.fillRect(0, 0, main_ctx.canvas.width, main_ctx.canvas.height);
                this.update_coach_sequence(zug_nr, main_ctx, fullScreen, scale);
                const data = getTrainData(zug_nr);
                const scroll_start_x = this.print_train_info(
                    data["Informationen"] || "",
                    data["Zugnummer"] || "",
                    data["Zugnummer kurz"] || "",
                    data["Abfahrt"] || "",
                    data["Abweichend"] || "",
                    data["Ziel"] || "",
                    fullScreen ? data["Via-Halte 1"] || "" : data["Via-Halte 1 Small"] || "",
                    fullScreen ? data["Via-Halte 2"] || "" : data["Via-Halte 2 Small"] || "",
                    fullScreen ? data["Via-Halte 3"] || "" : data["Via-Halte 3 Small"] || "",
                    data["Gleiswechsel"] || "0",
                    main_ctx,
                    fullScreen,
                    scale,
                    overlay_ctx,
                    zug_nr
                );
                overlay_ctx.canvas.style.left = `${scroll_start_x / scale}px`; // unscale for css px
            }
        }

        function debounce(func, delay) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => func(...args), delay);
            };
        }

        function getTrainData(zug_nr) {
            const prefix = `zug${zug_nr}-`;
            const data = {
                Zugnummer: document.getElementById(prefix + 'zugnummer').value,
                "Zugnummer kurz": document.getElementById(prefix + 'zugnummer').value,
                Abfahrt: document.getElementById(prefix + 'abfahrt').value,
                Abweichend: document.getElementById(prefix + 'abweichend').value,
                Ziel: document.getElementById(prefix + 'ziel').value,
                "Via-Halte 1": document.getElementById(prefix + 'via1') ? document.getElementById(prefix + 'via1').value : '',
                "Via-Halte 2": document.getElementById(prefix + 'via2') ? document.getElementById(prefix + 'via2').value : '',
                "Via-Halte 3": document.getElementById(prefix + 'via3') ? document.getElementById(prefix + 'via3').value : '',
                "Via-Halte 1 Small": document.getElementById(prefix + 'via1-small').value,
                "Via-Halte 2 Small": document.getElementById(prefix + 'via2-small').value,
                "Via-Halte 3 Small": document.getElementById(prefix + 'via3-small').value,
                Informationen: document.getElementById(prefix + 'informationen').value,
                Richtung: parseInt(document.querySelector(`input[name="${prefix}richtung"]:checked`).value),
                Startmeter: parseFloat(document.getElementById(prefix + 'startmeter').value) || 0,
                Skalieren: document.getElementById(prefix + 'skalieren').checked,
                Gleiswechsel: document.getElementById(prefix + 'gleiswechsel').value || "0",
                PlatformLength: parseFloat(document.getElementById('bahnsteiglaenge').value) || 420,
            };
            try {
                data.Wagenreihung = JSON.parse(document.getElementById(prefix + 'wagenreihung').value).map(c => new Coach(c.coach_type, c.double_decker, c.length, c.coach_class, c.coach_number, c.amenities, c.start, c.stop));
            } catch (e) {
                data.Wagenreihung = [];
            }
            return data;
        }

        const td = new TrainDisplay();
        const FULL_WIDTH = 7680;
        const FULL_HEIGHT = 3200;
        const SMALL_WIDTH = FULL_WIDTH / 2;
        const SMALL_HEIGHT = FULL_HEIGHT;
        const FULL_BASE_WIDTH = 940;
        const SMALL_BASE_WIDTH = 470;
        const FULL_SCALE = FULL_WIDTH / FULL_BASE_WIDTH;
        const SMALL_SCALE = SMALL_WIDTH / SMALL_BASE_WIDTH;

        const containers = {
            1: { container: document.getElementById('preview-full-container'), width: FULL_WIDTH, height: FULL_HEIGHT, scale: FULL_SCALE, fullScreen: true },
            2: { container: document.getElementById('preview-small1-container'), width: SMALL_WIDTH, height: SMALL_HEIGHT, scale: SMALL_SCALE, fullScreen: false },
            3: { container: document.getElementById('preview-small2-container'), width: SMALL_WIDTH, height: SMALL_HEIGHT, scale: SMALL_SCALE, fullScreen: false }
        };

        Object.values(containers).forEach(({ container, width, height }) => {
            const mainCanvas = document.createElement('canvas');
            mainCanvas.width = width;
            mainCanvas.height = height;
            container.appendChild(mainCanvas);

            const overlayCanvas = document.createElement('canvas');
            overlayCanvas.style.position = 'absolute';
            overlayCanvas.style.top = '0';
            container.appendChild(overlayCanvas);
        });

        td.overlay_ctxs[1] = containers[1].container.lastChild.getContext('2d');
        td.overlay_ctxs[2] = containers[2].container.lastChild.getContext('2d');
        td.overlay_ctxs[3] = containers[3].container.lastChild.getContext('2d');

        const updateDisplays = debounce(() => {
            [1, 2, 3].forEach(zug_nr => {
                const { width, height, scale, fullScreen } = containers[zug_nr];
                const main_ctx = containers[zug_nr].container.firstChild.getContext('2d');
                const overlay_ctx = td.overlay_ctxs[zug_nr];
                td.update_train_display(zug_nr, main_ctx, overlay_ctx, fullScreen, scale);
            });
        }, 300);

        const inputs = document.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            input.addEventListener('input', updateDisplays);
            input.addEventListener('change', updateDisplays);
        });

        const merkmalRadios = document.querySelectorAll('input[name="merkmal"]');
        merkmalRadios.forEach(radio => radio.addEventListener('change', () => td.on_feature_button_change(radio.value)));

        function handleExport(zug_nr) {
            const data = getTrainData(zug_nr)["Wagenreihung"].map(c => ({
                coach_type: c.coach_type, double_decker: c.double_decker, length: c.length, coach_class: c.coach_class, coach_number: c.coach_number, amenities: c.amenities, start: c.start, stop: c.stop
            }));
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wagenreihung_zug${zug_nr}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function handleImport(zug_nr, fileInput) {
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    document.getElementById(`zug${zug_nr}-wagenreihung`).value = ev.target.result;
                    updateDisplays();
                };
                reader.readAsText(file);
            });
        }

        [1, 2, 3].forEach(zug_nr => {
            document.getElementById(`zug${zug_nr}-export-wagenreihung`).addEventListener('click', () => handleExport(zug_nr));
            const importBtn = document.getElementById(`zug${zug_nr}-import-wagenreihung`);
            const fileInput = document.getElementById(`zug${zug_nr}-file`);
            importBtn.addEventListener('click', () => fileInput.click());
            handleImport(zug_nr, fileInput);
        });

        document.getElementById('download-highres').addEventListener('click', () => {
            const fullContainer = containers[1].container;
            const mainCanvas = fullContainer.firstChild;
            const overlayCanvas = fullContainer.lastChild;
            const composited = document.createElement('canvas');
            composited.width = FULL_WIDTH;
            composited.height = FULL_HEIGHT;
            const comp_ctx = composited.getContext('2d');
            comp_ctx.drawImage(mainCanvas, 0, 0);
            comp_ctx.drawImage(overlayCanvas, parseFloat(overlayCanvas.style.left) * FULL_SCALE, 0);
            composited.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'train_display.png';
                a.click();
                URL.revokeObjectURL(url);
            });
        });

        updateDisplays();

        window.addEventListener('beforeunload', () => td.cleanup());
    </script>
</body>
</html>
