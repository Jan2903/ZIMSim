<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZugInfoMonitor</title>
    <style>
        body { background: midnightblue; color: white; font-family: sans-serif; }
        .section { margin-bottom: 20px; }
        .input-label { display: inline-block; width: 200px; }
        .displays { display: flex; flex-wrap: wrap; }
        .large { margin-right: 20px; }
        .small-displays { display: flex; }
        .small-display { margin-right: 20px; }
        canvas { background: midnightblue; }
        .header-line { position: relative; height: 100px; }
        .ziel-line, .via-line { height: 50px; }
    </style>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>

<div class="settings">
    <div class="section">
        <h2>Wagenreihung</h2>
        <label><input type="radio" name="merkmal" value="rotierend"> Rotierend</label><br>
        <label><input type="radio" name="merkmal" value="wagennummern" checked> Wagennummern</label><br>
        <label><input type="radio" name="merkmal" value="ausstattung"> Ausstattung</label><br>
        <label><input type="radio" name="merkmal" value="klasse"> Klasse</label>
    </div>

    <div class="section">
        <h2>Bahnhof</h2>
        <div>
            <label class="input-label">Bahnsteigl√§nge</label><input type="text" id="bahnsteiglaenge" value="420">
        </div>
        <div>
            <label class="input-label">Bahnhof/Station</label><input type="text" id="stop_name" value="">
        </div>
        <div>
            <label class="input-label">Gleis</label><input type="text" id="gleis" value="">
        </div>
    </div>

    <div class="section">
        <h2>Data Load</h2>
        <input type="file" id="load_json" accept=".json">
        <button onclick="loadJsonData()">Load All Data from JSON</button>
    </div>

    <div class="section">
        <h2>Train 1</h2>
        <div>
            <label class="input-label">Informationen</label><input type="text" data-train="1" data-field="Informationen" value="">
        </div>
        <div>
            <label class="input-label">Zugnummer</label><input type="text" data-train="1" data-field="Zugnummer" value="">
        </div>
        <div>
            <label class="input-label">Zugnummer kurz</label><input type="text" data-train="1" data-field="Zugnummer kurz" value="">
        </div>
        <div>
            <label class="input-label">Abfahrt</label><input type="text" data-train="1" data-field="Abfahrt" value="">
        </div>
        <div>
            <label class="input-label">Abweichend</label><input type="text" data-train="1" data-field="Abweichend" value="">
        </div>
        <div>
            <label class="input-label">Ziel</label><input type="text" data-train="1" data-field="Ziel" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 1</label><input type="text" data-train="1" data-field="Via-Halte 1" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 2</label><input type="text" data-train="1" data-field="Via-Halte 2" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 3</label><input type="text" data-train="1" data-field="Via-Halte 3" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 1 Small</label><input type="text" data-train="1" data-field="Via-Halte 1 Small" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 2 Small</label><input type="text" data-train="1" data-field="Via-Halte 2 Small" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 3 Small</label><input type="text" data-train="1" data-field="Via-Halte 3 Small" value="">
        </div>
        <div>
            <label class="input-label">Gleiswechsel</label><input type="text" data-train="1" data-field="Gleiswechsel" value="0">
        </div>
        <div>
            <label class="input-label">Wagenreihung (JSON array of objects)</label><textarea data-train="1" data-field="Wagenreihung">[]</textarea>
        </div>
        <div>
            <label class="input-label">PlatformLength</label><input type="text" data-train="1" data-field="PlatformLength" value="420">
        </div>
        <div>
            <label class="input-label">PlatformSections (JSON)</label><textarea data-train="1" data-field="PlatformSections">[["A", 69.7], ["B", 135.8], ["C", 208], ["D", 266], ["E", 315.65]]</textarea>
        </div>
        <div>
            <label class="input-label">TrainStart</label><input type="text" data-train="1" data-field="TrainStart" value="0">
        </div>
        <div>
            <label class="input-label">Direction</label>
            <select data-train="1" data-field="Richtung">
                <option value="0">0</option>
                <option value="1">1</option>
            </select>
        </div>
        <div>
            <label class="input-label">Skalieren</label><input type="checkbox" data-train="1" data-field="Skalieren">
        </div>
        <div>
            <input type="file" id="load_form1" accept=".json">
            <button onclick="loadFormation(1)">Load Formation Train 1</button>
        </div>
    </div>

    <div class="section">
        <h2>Train 2</h2>
        <div>
            <label class="input-label">Informationen</label><input type="text" data-train="2" data-field="Informationen" value="">
        </div>
        <div>
            <label class="input-label">Zugnummer</label><input type="text" data-train="2" data-field="Zugnummer" value="">
        </div>
        <div>
            <label class="input-label">Zugnummer kurz</label><input type="text" data-train="2" data-field="Zugnummer kurz" value="">
        </div>
        <div>
            <label class="input-label">Abfahrt</label><input type="text" data-train="2" data-field="Abfahrt" value="">
        </div>
        <div>
            <label class="input-label">Abweichend</label><input type="text" data-train="2" data-field="Abweichend" value="">
        </div>
        <div>
            <label class="input-label">Ziel</label><input type="text" data-train="2" data-field="Ziel" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 1</label><input type="text" data-train="2" data-field="Via-Halte 1" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 2</label><input type="text" data-train="2" data-field="Via-Halte 2" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 3</label><input type="text" data-train="2" data-field="Via-Halte 3" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 1 Small</label><input type="text" data-train="2" data-field="Via-Halte 1 Small" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 2 Small</label><input type="text" data-train="2" data-field="Via-Halte 2 Small" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 3 Small</label><input type="text" data-train="2" data-field="Via-Halte 3 Small" value="">
        </div>
        <div>
            <label class="input-label">Gleiswechsel</label><input type="text" data-train="2" data-field="Gleiswechsel" value="0">
        </div>
        <div>
            <label class="input-label">Wagenreihung (JSON array of objects)</label><textarea data-train="2" data-field="Wagenreihung">[]</textarea>
        </div>
        <div>
            <label class="input-label">PlatformLength</label><input type="text" data-train="2" data-field="PlatformLength" value="420">
        </div>
        <div>
            <label class="input-label">PlatformSections (JSON)</label><textarea data-train="2" data-field="PlatformSections">[["A", 69.7], ["B", 135.8], ["C", 208], ["D", 266], ["E", 315.65]]</textarea>
        </div>
        <div>
            <label class="input-label">TrainStart</label><input type="text" data-train="2" data-field="TrainStart" value="0">
        </div>
        <div>
            <label class="input-label">Direction</label>
            <select data-train="2" data-field="Richtung">
                <option value="0">0</option>
                <option value="1">1</option>
            </select>
        </div>
        <div>
            <label class="input-label">Skalieren</label><input type="checkbox" data-train="2" data-field="Skalieren">
        </div>
        <div>
            <input type="file" id="load_form2" accept=".json">
            <button onclick="loadFormation(2)">Load Formation Train 2</button>
        </div>
    </div>

    <div class="section">
        <h2>Train 3</h2>
        <div>
            <label class="input-label">Informationen</label><input type="text" data-train="3" data-field="Informationen" value="">
        </div>
        <div>
            <label class="input-label">Zugnummer</label><input type="text" data-train="3" data-field="Zugnummer" value="">
        </div>
        <div>
            <label class="input-label">Zugnummer kurz</label><input type="text" data-train="3" data-field="Zugnummer kurz" value="">
        </div>
        <div>
            <label class="input-label">Abfahrt</label><input type="text" data-train="3" data-field="Abfahrt" value="">
        </div>
        <div>
            <label class="input-label">Abweichend</label><input type="text" data-train="3" data-field="Abweichend" value="">
        </div>
        <div>
            <label class="input-label">Ziel</label><input type="text" data-train="3" data-field="Ziel" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 1</label><input type="text" data-train="3" data-field="Via-Halte 1" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 2</label><input type="text" data-train="3" data-field="Via-Halte 2" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 3</label><input type="text" data-train="3" data-field="Via-Halte 3" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 1 Small</label><input type="text" data-train="3" data-field="Via-Halte 1 Small" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 2 Small</label><input type="text" data-train="3" data-field="Via-Halte 2 Small" value="">
        </div>
        <div>
            <label class="input-label">Via-Halte 3 Small</label><input type="text" data-train="3" data-field="Via-Halte 3 Small" value="">
        </div>
        <div>
            <label class="input-label">Gleiswechsel</label><input type="text" data-train="3" data-field="Gleiswechsel" value="0">
        </div>
        <div>
            <label class="input-label">Wagenreihung (JSON array of objects)</label><textarea data-train="3" data-field="Wagenreihung">[]</textarea>
        </div>
        <div>
            <label class="input-label">PlatformLength</label><input type="text" data-train="3" data-field="PlatformLength" value="420">
        </div>
        <div>
            <label class="input-label">PlatformSections (JSON)</label><textarea data-train="3" data-field="PlatformSections">[["A", 69.7], ["B", 135.8], ["C", 208], ["D", 266], ["E", 315.65]]</textarea>
        </div>
        <div>
            <label class="input-label">TrainStart</label><input type="text" data-train="3" data-field="TrainStart" value="0">
        </div>
        <div>
            <label class="input-label">Direction</label>
            <select data-train="3" data-field="Richtung">
                <option value="0">0</option>
                <option value="1">1</option>
            </select>
        </div>
        <div>
            <label class="input-label">Skalieren</label><input type="checkbox" data-train="3" data-field="Skalieren">
        </div>
        <div>
            <input type="file" id="load_form3" accept=".json">
            <button onclick="loadFormation(3)">Load Formation Train 3</button>
        </div>
    </div>
</div>

<button onclick="downloadScreenshot()">Download Screenshot</button>

<div class="displays">
    <div class="large">
        <h3>Large Display (Train 1 Full Screen)</h3>
        <div class="header-line">
            <canvas id="large_header" width="1880" height="200" style="width:940px; height:100px; position: absolute; left:0;"></canvas>
            <div class="large_icons" style="position: absolute; right: 0; top: 0; height:100px; line-height:100px;"></div>
        </div>
        <div class="ziel-line">
            <canvas id="large_ziel" width="1880" height="100" style="width:940px; height:50px;"></canvas>
        </div>
        <div class="via-line">
            <canvas id="large_via1" width="1880" height="100" style="width:940px; height:50px;"></canvas>
        </div>
        <div class="via-line">
            <canvas id="large_via2" width="1880" height="100" style="width:940px; height:50px;"></canvas>
        </div>
        <div class="via-line">
            <canvas id="large_via3" width="1880" height="100" style="width:940px; height:50px;"></canvas>
        </div>
        <canvas id="large_formation" width="1880" height="258" style="width:940px; height:129px;"></canvas>
    </div>
    <div class="small-displays">
        <div class="small-display">
            <h3>Small Display (Train 2)</h3>
            <canvas id="small2_header" width="940" height="60" style="width:470px; height:30px;"></canvas>
            <canvas id="small2_info" width="940" height="60" style="width:470px; height:30px;"></canvas>
            <canvas id="small2_ziel" width="940" height="60" style="width:470px; height:30px;"></canvas>
            <canvas id="small2_via1" width="940" height="60" style="width:470px; height:30px;"></canvas>
            <canvas id="small2_via2" width="940" height="60" style="width:470px; height:30px;"></canvas>
            <canvas id="small2_via3" width="940" height="60" style="width:470px; height:30px;"></canvas>
            <canvas id="small2_formation" width="940" height="258" style="width:470px; height:129px;"></canvas>
        </div>
        <div class="small-display">
            <h3>Small Display (Train 3)</h3>
            <canvas id="small3_header" width="940" height="60" style="width:470px; height:30px;"></canvas>
            <canvas id="small3_info" width="940" height="60" style="width:470px; height:30px;"></canvas>
            <canvas id="small3_ziel" width="940" height="60" style="width:470px; height:30px;"></canvas>
            <canvas id="small3_via1" width="940" height="60" style="width:470px; height:30px;"></canvas>
            <canvas id="small3_via2" width="940" height="60" style="width:470px; height:30px;"></canvas>
            <canvas id="small3_via3" width="940" height="60" style="width:470px; height:30px;"></canvas>
            <canvas id="small3_formation" width="940" height="258" style="width:470px; height:129px;"></canvas>
        </div>
    </div>
</div>

<script>
const scale = 2;

class Coach {
    constructor(coach_type, double_decker, length, coach_class, coach_number, amenities, start, stop) {
        this.coach_type = coach_type;
        this.double_decker = double_decker;
        this.length = parseInt(length) || 0;
        this.coach_class = parseInt(coach_class) || null;
        this.coach_number = parseInt(coach_number) || 0;
        this.amenities = amenities || '';
        this.start = parseInt(start) || 0;
        this.stop = parseInt(stop) || 0;
    }
    has_amenity(amenity) {
        return this.amenities === amenity;
    }
    is_first_class() {
        return this.coach_class === 1;
    }
    is_locomotive() {
        return this.coach_type === 'l';
    }
}

let trainData = {
    zug_daten: {
        1: {
            "Informationen": "", "Zugnummer": "", "Zugnummer kurz": "", "Abfahrt": "", "Abweichend": "", "Ziel": "", 
            "Via-Halte 1": "", "Via-Halte 2": "", "Via-Halte 3": "", "Via-Halte 1 Small": "", "Via-Halte 2 Small": "", "Via-Halte 3 Small": "", "Gleiswechsel": "0",
            "Wagenreihung": [], "PlatformLength": 420, "PlatformSections": [["A", 69.7], ["B", 135.8], ["C", 208], ["D", 266], ["E", 315.65]], "TrainStart": 0, "Richtung": 0, "Skalieren": false
        },
        2: {
            "Informationen": "", "Zugnummer": "", "Zugnummer kurz": "", "Abfahrt": "", "Abweichend": "", "Ziel": "", 
            "Via-Halte 1": "", "Via-Halte 2": "", "Via-Halte 3": "", "Via-Halte 1 Small": "", "Via-Halte 2 Small": "", "Via-Halte 3 Small": "", "Gleiswechsel": "0",
            "Wagenreihung": [], "PlatformLength": 420, "PlatformSections": [["A", 69.7], ["B", 135.8], ["C", 208], ["D", 266], ["E", 315.65]], "TrainStart": 0, "Richtung": 0, "Skalieren": false
        },
        3: {
            "Informationen": "", "Zugnummer": "", "Zugnummer kurz": "", "Abfahrt": "", "Abweichend": "", "Ziel": "", 
            "Via-Halte 1": "", "Via-Halte 2": "", "Via-Halte 3": "", "Via-Halte 1 Small": "", "Via-Halte 2 Small": "", "Via-Halte 3 Small": "", "Gleiswechsel": "0",
            "Wagenreihung": [], "PlatformLength": 420, "PlatformSections": [["A", 69.7], ["B", 135.8], ["C", 208], ["D", 266], ["E", 315.65]], "TrainStart": 0, "Richtung": 0, "Skalieren": false
        }
    },
    current_stop: "",
    current_platform: ""
};

const inputs = document.querySelectorAll('input[data-train], textarea[data-train], select[data-train]');
inputs.forEach(input => {
    input.addEventListener('input', () => {
        const train = input.dataset.train;
        const field = input.dataset.field;
        let val;
        if (input.type === 'checkbox') {
            val = input.checked;
        } else if (input.tagName === 'SELECT') {
            val = parseInt(input.value);
        } else {
            val = input.value;
        }
        if (field === 'Wagenreihung') {
            try {
                val = JSON.parse(val);
                trainData.zug_daten[train][field] = val.map(obj => new Coach(obj.coach_type, obj.double_decker, obj.length, obj.coach_class, obj.coach_number, obj.amenities, obj.start, obj.stop));
            } catch (e) {
                console.error('Invalid Wagenreihung JSON');
            }
        } else if (field === 'PlatformSections') {
            try {
                trainData.zug_daten[train][field] = JSON.parse(val);
            } catch (e) {
                console.error('Invalid PlatformSections JSON');
            }
        } else if (['PlatformLength', 'TrainStart', 'Richtung', 'Gleiswechsel'].includes(field)) {
            trainData.zug_daten[train][field] = parseFloat(val) || 0;
        } else if (field === 'Skalieren') {
            trainData.zug_daten[train][field] = val;
        } else {
            trainData.zug_daten[train][field] = val;
        }
        updateAllDisplays();
    });
});

document.getElementById('bahnsteiglaenge').addEventListener('input', () => {
    const value = parseFloat(document.getElementById('bahnsteiglaenge').value) || 420;
    for (let i = 1; i <= 3; i++) {
        trainData.zug_daten[i]['PlatformLength'] = value;
    }
    updateAllDisplays();
});

document.getElementById('stop_name').addEventListener('input', () => {
    trainData.current_stop = document.getElementById('stop_name').value;
});

document.getElementById('gleis').addEventListener('input', () => {
    trainData.current_platform = document.getElementById('gleis').value;
});

let aktuelles_merkmal = 'wagennummern';
let rotating = false;
let rotationsIndex = 0;
let merkmale = ['wagennummern', 'ausstattung', 'klasse'];
let rotationTimer = null;

const merkmalRadios = document.querySelectorAll('input[name="merkmal"]');
merkmalRadios.forEach(radio => {
    radio.addEventListener('change', () => {
        if (radio.value === 'rotierend') {
            rotating = true;
            rotateFeature();
        } else {
            rotating = false;
            if (rotationTimer) clearTimeout(rotationTimer);
            aktuelles_merkmal = radio.value;
            updateAllFormations();
        }
    });
});

function rotateFeature() {
    if (!rotating) return;
    aktuelles_merkmal = merkmale[rotationsIndex];
    rotationsIndex = (rotationsIndex + 1) % merkmale.length;
    updateAllFormations();
    rotationTimer = setTimeout(rotateFeature, 3000);
}

let scrollIntervals = {};

function startScroll(canvasId, text, font, color, startX, y, speed = 2, bg = null) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    ctx.scale(scale, scale);
    ctx.font = font;
    const textWidth = ctx.measureText(text).width;
    const canvasWidth = canvas.width / scale;
    if (textWidth <= canvasWidth - startX) {
        ctx.clearRect(0, 0, canvasWidth, canvas.height / scale);
        if (bg) {
            ctx.fillStyle = bg;
            ctx.fillRect(0, 0, canvasWidth, canvas.height / scale);
        }
        ctx.fillStyle = color;
        ctx.fillText(text, startX, y);
        return;
    }
    let x = startX;
    if (scrollIntervals[canvasId]) clearInterval(scrollIntervals[canvasId]);
    scrollIntervals[canvasId] = setInterval(() => {
        ctx.clearRect(0, 0, canvasWidth, canvas.height / scale);
        if (bg) {
            ctx.fillStyle = bg;
            ctx.fillRect(0, 0, canvasWidth, canvas.height / scale);
        }
        ctx.fillStyle = color;
        ctx.fillText(text, x, y);
        x -= speed;
        if (x < -textWidth) x = canvasWidth;
    }, 30);
}

function stopScroll(canvasId) {
    if (scrollIntervals[canvasId]) clearInterval(scrollIntervals[canvasId]);
    delete scrollIntervals[canvasId];
}

function updateAllDisplays() {
    updateTrainDisplay(1, 'large', true);
    updateTrainDisplay(2, 'small2', false);
    updateTrainDisplay(3, 'small3', false);
}

function updateAllFormations() {
    updateCoachSequence(1, 'large_formation', true);
    updateCoachSequence(2, 'small2_formation', false);
    updateCoachSequence(3, 'small3_formation', false);
}

function updateCoachSequence(zug_nr, canvasId, fullScreen) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    ctx.scale(scale, scale);
    const draw_width = fullScreen ? 940 : 470;
    const draw_height = fullScreen ? 129 : 129;
    ctx.clearRect(0, 0, draw_width, draw_height);
    let coaches = trainData.zug_daten[zug_nr].Wagenreihung.slice() || [];
    let platform_length = trainData.zug_daten[zug_nr].PlatformLength || 420;
    let platform_sections = trainData.zug_daten[zug_nr].PlatformSections.slice() || [];
    const train_start = trainData.zug_daten[zug_nr].TrainStart || 0;
    const richtung = trainData.zug_daten[zug_nr].Richtung || 0;
    const skalieren = trainData.zug_daten[zug_nr].Skalieren || false;
    const gleiswechsel = trainData.zug_daten[zug_nr].Gleiswechsel || "0";
    const nr = trainData.zug_daten[zug_nr]["Zugnummer"] || "";
    if (gleiswechsel !== "0" && canvasId === 'small3_formation') {
        ctx.fillStyle = 'orange';
        ctx.fillRect(0, 0, draw_width, draw_height);
        ctx.fillStyle = 'white';
        ctx.font = '20px sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText('Neues Gleis', 25, 25);
        ctx.font = 'italic 20px sans-serif';
        ctx.fillText('New Track', 25, 55);
        ctx.font = '42px sans-serif';
        ctx.textAlign = 'right';
        ctx.fillText(gleiswechsel, 445, 40);
        return;
    }
    if (coaches.length === 0 && nr && !fullScreen) {
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(0, 129);
        ctx.moveTo(draw_width, 0);
        ctx.lineTo(draw_width, 129);
        ctx.stroke();
        return;
    }
    if (coaches.length > 0) {
        if (richtung === 1) {
            coaches.forEach(coach => {
                if (coach.coach_type === 'a') coach.coach_type = 'e';
                else if (coach.coach_type === 'e') coach.coach_type = 'a';
                if (coach.coach_type === 'ma') coach.coach_type = 'me';
                else if (coach.coach_type === 'me') coach.coach_type = 'ma';
                const old_start = coach.start;
                coach.start = platform_length - coach.stop;
                coach.stop = coach.start + coach.length;
            });
            coaches.reverse();
            platform_sections.reverse();
            platform_sections.forEach(s => s[1] = platform_length - s[1]);
        }
        let min_start = Math.min(...coaches.map(c => c.start));
        let max_stop = Math.max(...coaches.map(c => c.stop));
        let train_length = max_stop - min_start;
        let factor = skalieren ? draw_width / train_length : draw_width / platform_length;
        coaches.forEach(coach => {
            coach.start = (coach.start - min_start - train_start) * factor;
            coach.stop = coach.start + (coach.stop - coach.start) * factor; // recalculate based on original length * factor? But original length is stop - start
            coach.length = coach.stop - coach.start;
        });
        printDirection(richtung, fullScreen ? 20 : 5, ctx);
        coaches.forEach(coach => {
            let x = coach.start;
            if (coach.is_locomotive()) {
                printLocomotive(coach, x, ctx);
            } else if (['a', 'ma'].includes(coach.coach_type)) {
                printStartWagon(coach, x, ctx);
            } else if (coach.coach_type === 'm') {
                printMiddleWagon(coach, x, ctx);
            } else if (['e', 'me'].includes(coach.coach_type)) {
                printEndWagon(coach, x, ctx);
            }
            printFirstClass(coach, x, ctx, fullScreen);
        });
        if (aktuelles_merkmal === 'klasse') {
            if (fullScreen) {
                printClassCompact(coaches, ctx);
            } else {
                coaches.forEach(coach => printClass(coach, coach.start, ctx));
            }
        } else if (aktuelles_merkmal === 'ausstattung') {
            if (fullScreen) {
                printAmenitiesCompact(coaches, ctx);
            } else {
                coaches.forEach(coach => printAmenities(coach, coach.start, ctx));
            }
        } else if (aktuelles_merkmal === 'wagennummern') {
            if (fullScreen) {
                printWagonNumbersCompact(coaches, ctx);
            } else {
                coaches.forEach(coach => printWagonNumbers(coach, coach.start, ctx));
            }
        }
        if (!skalieren && platform_sections.length > 0) {
            printSectors(platform_sections, ctx, fullScreen, factor, platform_length);
        }
    }
}

function printAmenitiesCompact(coaches, ctx) {
    let group = [];
    function processGroup(group) {
        if (!group.length) return;
        const first = group[0];
        const last = group[group.length - 1];
        const center = (first.start + last.stop) / 2;
        const amenity = first.amenities;
        if (amenity) {
            ctx.fillStyle = 'white';
            ctx.font = '16px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(amenity, center, 35 + 20);
        }
    }
    coaches.forEach(coach => {
        if (!group.length || coach.amenities === group[0].amenities) {
            group.push(coach);
        } else {
            processGroup(group);
            group = [coach];
        }
    });
    processGroup(group);
}

function printWagonNumbersCompact(coaches, ctx) {
    let group = [];
    function processGroup(group) {
        if (!group.length) return;
        const first = group[0];
        const last = group[group.length - 1];
        const center = (first.start + last.stop) / 2;
        if (first.coach_number && last.coach_number) {
            let text = first.coach_number === last.coach_number ? first.coach_number.toString() : first.coach_number + '-' + last.coach_number;
            ctx.fillStyle = 'white';
            ctx.font = '16px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(text, center, 35 - 10);
        }
    }
    coaches.forEach(coach, i => {
        if (!group.length || (coach.coach_number === group[group.length-1].coach_number + 1)) {
            group.push(coach);
        } else {
            processGroup(group);
            group = [coach];
        }
    });
    processGroup(group);
}

function loadJsonData() {
    const file = document.getElementById('load_json').files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        const data = JSON.parse(e.target.result);
        for (let i = 1; i <= 3; i++) {
            const zug = data[`zug_${i}`];
            if (zug) {
                Object.keys(zug).forEach(key => {
                    if (key === 'Wagenreihung') {
                        trainData.zug_daten[i][key] = zug[key].map(c => new Coach(c.coach_type, c.double_decker, c.length, c.coach_class, c.coach_number, c.amenities, c.start, c.stop));
                    } else if (key === 'PlatformSections') {
                        trainData.zug_daten[i][key] = zug[key];
                    } else if (['PlatformLength', 'TrainStart', 'Richtung', 'Gleiswechsel'].includes(key)) {
                        trainData.zug_daten[i][key] = Number(zug[key]);
                    } else if (key === 'Skalieren') {
                        trainData.zug_daten[i][key] = zug[key];
                    } else {
                        trainData.zug_daten[i][key] = zug[key];
                    }
                });
                // Update inputs
                document.querySelectorAll(`[data-train="${i}"]`).forEach(inp => {
                    const field = inp.dataset.field;
                    const val = trainData.zug_daten[i][field];
                    if (inp.type === 'checkbox') {
                        inp.checked = val;
                    } else if (inp.tagName === 'TEXTAREA') {
                        inp.value = JSON.stringify(val);
                    } else if (inp.tagName === 'SELECT') {
                        inp.value = val;
                    } else {
                        inp.value = val;
                    }
                });
            }
        }
        updateAllDisplays();
    };
    reader.readAsText(file);
}

function loadFormation(train) {
    const file = document.getElementById(`load_form${train}`).files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        const arr = JSON.parse(e.target.result);
        trainData.zug_daten[train].Wagenreihung = arr.map(c => new Coach(c.coach_type, c.double_decker, c.length, c.coach_class, c.coach_number, c.amenities, c.start, c.stop));
        document.querySelector(`[data-train="${train}"][data-field="Wagenreihung"]`).value = JSON.stringify(arr);
        updateAllDisplays();
    };
    reader.readAsText(file);
}

function downloadScreenshot() {
    html2canvas(document.querySelector('.displays'), {scale: 2}).then(canvas => {
        let link = document.createElement('a');
        link.download = 'zuginfo.png';
        link.href = canvas.toDataURL();
        link.click();
    });
}

updateAllDisplays();
</script>
</body>
</html>
